clear;
setup_OptiPlex;
dir_trunk = '/home/rangan/dir_bcc/dir_dolphin';
dir_jpg = sprintf('%s/dir_jpg',dir_trunk);

flag_replot=0;

fname_data = sprintf('%s/Dolphin_Data_201918755_s2.xlsx',dir_trunk);
T_ = readtable(fname_data);
aid_ori_ = T_{:,1};
age_ori_ = T_{:,4};
nvar_base = 7;
dat_ori__ = T_{:,(1+nvar_base):end};
n_smp_ori = size(dat_ori__,1);
n_var_ori = size(dat_ori__,2);
string_dat_ori_name_ = cell(n_var_ori,1);
for nvar=0:n_var_ori-1;
string_dat_ori_name_{1+nvar} = T_.Properties.VariableNames{1+nvar_base+nvar};
end;%for nvar=0:n_var_ori-1;

dat_ret__ = dat_ori__;
mss_var_threshold = 500;
index_var_ret_ = setdiff(0:n_var_ori-1,efind(sum(~isfinite(dat_ret__),1)>mss_var_threshold));
dat_ret__ = dat_ret__(:,1+index_var_ret_);
n_var_ret = size(dat_ret__,2);
string_dat_ret_name_ = cell(n_var_ret,1);
for nvar=0:n_var_ret-1;
string_dat_ret_name_{1+nvar} = string_dat_ori_name_{1+index_var_ret_(1+nvar)};
end;%for nvar=0:n_var_ret-1;

mss_smp_threshold = 7;
index_smp_ret_ = setdiff(0:n_smp_ori-1,efind(sum(~isfinite(dat_ret__),2)>mss_smp_threshold));
dat_ret__ = dat_ret__(1+index_smp_ret_,:);
n_smp_ret = size(dat_ret__,1);

fname_fig = sprintf('%s/dolphin_ori_vs_ret',dir_jpg);
if (flag_replot | ~exist(sprintf('%s.jpg',fname_fig),'file'));
disp(sprintf(' %% %s not found, creating',fname_fig));
subplot(2,2,1); stairs(cumsum(sort(sum(~isfinite(dat_ori__),1)))/numel(dat_ori__)); title('cumsum(sum(~isfinite(dat_ori__),1))','Interpreter','none');
subplot(2,2,2); stairs(cumsum(sort(sum(~isfinite(dat_ori__),2)))/numel(dat_ori__)); title('cumsum(sum(~isfinite(dat_ori__),2))','Interpreter','none');
subplot(2,2,3); stairs(cumsum(sort(sum(~isfinite(dat_ret__),1)))/numel(dat_ret__)); title('cumsum(sum(~isfinite(dat_ret__),1))','Interpreter','none');
subplot(2,2,4); stairs(cumsum(sort(sum(~isfinite(dat_ret__),2)))/numel(dat_ret__)); title('cumsum(sum(~isfinite(dat_ret__),2))','Interpreter','none');
figbig;
sgtitle('original vs retained')
disp(sprintf(' %% writing %s',fname_fig));
print('-depsc',sprintf('%s.eps',fname_fig));
print('-djpeg',sprintf('%s.jpg',fname_fig));
close(gcf);
end;%if (~exist(sprintf('%s.jpg',fname_fig),'file'));
if ( exist(sprintf('%s.jpg',fname_fig),'file'));
disp(sprintf(' %% %s found, not creating',fname_fig));
end;%if ( exist(sprintf('%s.jpg',fname_fig),'file'));

aid_ret_ = aid_ori_(1+index_smp_ret_);
age_ret_ = age_ori_(1+index_smp_ret_);

aid_ = aid_ret_;
age_ = age_ret_;
dat__ = dat_ret__;
[n_smp,n_var] = size(dat__);
string_dat_name_ = string_dat_ret_name_;

u_aid_ = unique(aid_);
n_aid = numel(u_aid_);
n_aid_ = zeros(n_aid,1);
index_aid__ = cell(n_aid,1);
for naid=0:n_aid-1;
index_aid__{1+naid} = efind(aid_==u_aid_(1+naid));
n_aid_(1+naid) = numel(index_aid__{1+naid});
end;%for naid=0:n_aid-1;

fname_fig = sprintf('%s/dolphin_dt_scatter_A',dir_jpg);
if (flag_replot | ~exist(sprintf('%s.jpg',fname_fig),'file'));
disp(sprintf(' %% %s not found, creating',fname_fig));
figure(1);
clf;
c_ = colormap_beach(); n_c = size(c_,1);
n_plot_row = 5;
n_plot_col = 10;
nplot=0;
for nvar=0:24;%for nvar=0:n_var-1;
dt_all_ = [];
dv_all_ = [];
for naid=0:n_aid-1;
nc = max(0,min(n_c-1,floor(n_c*naid/n_aid)));
tmp_index_finite_ = efind(isfinite(dat__(1+index_aid__{1+naid},1+nvar)));
tmp_index_aid_ = index_aid__{1+naid}(1+tmp_index_finite_);
tmp_age_ = age_(1+tmp_index_aid_);
[tmp_age_,tmp_index_] = sort(tmp_age_,'ascend'); tmp_index_ = tmp_index_-1;
tmp_var_ = dat__(1+tmp_index_aid_,1+nvar); tmp_var_ = tmp_var_(1+tmp_index_);
dt_ = diff(tmp_age_);
dv_ = diff(tmp_var_);
dt_all_ = [dt_all_;dt_];
dv_all_ = [dv_all_;dv_];
subplot(n_plot_row,n_plot_col,1+nplot+0);
hold on;
plot(sqrt(dt_),dv_,'.','Color',c_(1+nc,:));
hold off;
end;%for naid=0:n_aid-1;
xlim_ = sqrt([0,5]);
ylim_ = prctile(dv_all_,[1,99]);
%subplot(n_plot_row,n_plot_col,1+nplot+1);
%plot(tmp_age_,tmp_var_,'.-','Color',c_(1+nc,:));
subplot(n_plot_row,n_plot_col,1+nplot+0);
xlim(xlim_); ylim(ylim_); title(sprintf('%s',string_dat_name_{1+nvar}));
subplot(n_plot_row,n_plot_col,1+nplot+1);
n_h = 32;
tmp_h__ = hist2d_0(sqrt(dt_all_),dv_all_,n_h,n_h,xlim_,ylim_);
tmp_e_ = linspace(ylim_(1),ylim_(2),n_h);
tmp_b_ = 1:n_h;
tmp_avg_ = zeros(n_h,1);
tmp_std_ = zeros(n_h,1);
for nh=0:n_h-1;
tmp_h__(:,1+nh) = tmp_h__(:,1+nh)/max(1,sum(tmp_h__(:,1+nh)));
tmp_avg_(1+nh) = dot(tmp_b_,tmp_h__(:,1+nh));
tmp_std_(1+nh) = sqrt(dot(tmp_b_.*tmp_b_,tmp_h__(:,1+nh)) - tmp_avg_(1+nh).^2);
end;%for nh=0:31;
hold on;
imagesc(tmp_h__,[0.02,0.20]);
colormap(colormap_beach());
plot(tmp_b_,tmp_avg_,'k.');
plot(tmp_b_,tmp_avg_+1.0*tmp_std_,'k.');
plot(tmp_b_,tmp_avg_-1.0*tmp_std_,'k.');
hold off;
xlim([1,n_h]); ylim([1,n_h]);
axisnotick;
title(sprintf('%s',string_dat_name_{1+nvar}));
nplot=nplot+2;
end;%for nvar=0:n_var-1;
figbig;
sgtitle('sqrt(dt) horizontal, dv vertical')
disp(sprintf(' %% writing %s',fname_fig));
print('-depsc',sprintf('%s.eps',fname_fig));
print('-djpeg',sprintf('%s.jpg',fname_fig));
close(gcf);
end;%if (~exist(sprintf('%s.jpg',fname_fig),'file'));
if ( exist(sprintf('%s.jpg',fname_fig),'file'));
disp(sprintf(' %% %s found, not creating',fname_fig));
end;%if ( exist(sprintf('%s.jpg',fname_fig),'file'));

fname_fig = sprintf('%s/dolphin_dt_scatter_B',dir_jpg);
if (flag_replot | ~exist(sprintf('%s.jpg',fname_fig),'file'));
disp(sprintf(' %% %s not found, creating',fname_fig));
figure(1);
clf;
c_ = colormap_beach(); n_c = size(c_,1);
n_plot_row = 5;
n_plot_col = 10;
nplot=0;
for nvar=25:n_var-1;%for nvar=0:n_var-1;
dt_all_ = [];
dv_all_ = [];
for naid=0:n_aid-1;
nc = max(0,min(n_c-1,floor(n_c*naid/n_aid)));
tmp_index_finite_ = efind(isfinite(dat__(1+index_aid__{1+naid},1+nvar)));
tmp_index_aid_ = index_aid__{1+naid}(1+tmp_index_finite_);
tmp_age_ = age_(1+tmp_index_aid_);
[tmp_age_,tmp_index_] = sort(tmp_age_,'ascend'); tmp_index_ = tmp_index_-1;
tmp_var_ = dat__(1+tmp_index_aid_,1+nvar); tmp_var_ = tmp_var_(1+tmp_index_);
dt_ = diff(tmp_age_);
dv_ = diff(tmp_var_);
dt_all_ = [dt_all_;dt_];
dv_all_ = [dv_all_;dv_];
subplot(n_plot_row,n_plot_col,1+nplot+0);
hold on;
plot(sqrt(dt_),dv_,'.','Color',c_(1+nc,:));
hold off;
end;%for naid=0:n_aid-1;
xlim_ = sqrt([0,5]);
ylim_ = prctile(dv_all_,[1,99]);
%subplot(n_plot_row,n_plot_col,1+nplot+1);
%plot(tmp_age_,tmp_var_,'.-','Color',c_(1+nc,:));
subplot(n_plot_row,n_plot_col,1+nplot+0);
xlim(xlim_); ylim(ylim_); title(sprintf('%s',string_dat_name_{1+nvar}));
subplot(n_plot_row,n_plot_col,1+nplot+1);
n_h = 32;
tmp_h__ = hist2d_0(sqrt(dt_all_),dv_all_,n_h,n_h,xlim_,ylim_);
tmp_e_ = linspace(ylim_(1),ylim_(2),n_h);
tmp_b_ = 1:n_h;
tmp_avg_ = zeros(n_h,1);
tmp_std_ = zeros(n_h,1);
for nh=0:n_h-1;
tmp_h__(:,1+nh) = tmp_h__(:,1+nh)/max(1,sum(tmp_h__(:,1+nh)));
tmp_avg_(1+nh) = dot(tmp_b_,tmp_h__(:,1+nh));
tmp_std_(1+nh) = sqrt(dot(tmp_b_.*tmp_b_,tmp_h__(:,1+nh)) - tmp_avg_(1+nh).^2);
end;%for nh=0:31;
hold on;
imagesc(tmp_h__,[0.02,0.20]);
colormap(colormap_beach());
plot(tmp_b_,tmp_avg_,'k.');
plot(tmp_b_,tmp_avg_+1.0*tmp_std_,'k.');
plot(tmp_b_,tmp_avg_-1.0*tmp_std_,'k.');
hold off;
xlim([1,n_h]); ylim([1,n_h]);
axisnotick;
title(sprintf('%s',string_dat_name_{1+nvar}));
nplot=nplot+2;
end;%for nvar=0:n_var-1;
figbig;
sgtitle('sqrt(dt) horizontal, dv vertical')
disp(sprintf(' %% writing %s',fname_fig));
print('-depsc',sprintf('%s.eps',fname_fig));
print('-djpeg',sprintf('%s.jpg',fname_fig));
close(gcf);
end;%if (~exist(sprintf('%s.jpg',fname_fig),'file'));
if ( exist(sprintf('%s.jpg',fname_fig),'file'));
disp(sprintf(' %% %s found, not creating',fname_fig));
end;%if ( exist(sprintf('%s.jpg',fname_fig),'file'));


% We prepend two columns to the data: ;
% 0: a column of all ones. ;
% 1: a column equal to the age_ vector. ;
% These first two columns will correspond to the first two columns/rows of A__, B__ and C__. ;
dat_aug__ = [ ones(n_smp,1) , age_ , normalize(dat__,'zscore') ];
n_var_aug = size(dat_aug__,2);
string_dat_aug_name_ = cell(n_var_aug,1);
nvar=0;string_dat_aug_name_{1+nvar}='one';
nvar=1;string_dat_aug_name_{1+nvar}='age';
for nvar=0:n_var-1;
string_dat_aug_name_{1+nvar+2} = string_dat_name_{1+nvar};
end;%for nvar=0:n_var-1;
index_mss_ = efind(~isfinite(dat_aug__));
A__ = zeros(n_var_aug,n_var_aug); A__(1+1,1+0) = 1; %<-- time evolves at a rate of 1. ;
B__ = []; C__ = [];
%%%%%%%%;
% Now impute data using A. ;
%%%%%%%%;
dat_imp__ = dolphin_impute_0(aid_,age_,dat_aug__,A__,index_mss_);
%%%%%%%%;
% Now estimate initial B,C. ;
%%%%%%%%;
[BB__,CC__,l2_R__,sum_1,sum_dt,sum_dtdt,sum_DDj__,sum_DDjdt__] = dolphin_estimate_BC_0(aid_,age_,dat_imp__,A__);

colormap(colormap_beach());
subplot(1,3,1);
imagesc(BB__); axis image; title('BB__','Interpreter','none');
set(gca,'XTick',1:n_var_aug,'XTickLabel',string_dat_aug_name_);xtickangle(90);
set(gca,'YTick',1:n_var_aug,'YTickLabel',string_dat_aug_name_);
subplot(1,3,2);
imagesc(CC__); axis image; title('CC__','Interpreter','none');
set(gca,'XTick',1:n_var_aug,'XTickLabel',string_dat_aug_name_);xtickangle(90);
set(gca,'YTick',1:n_var_aug,'YTickLabel',string_dat_aug_name_);
subplot(1,3,3);
imagesc(log10(l2_R__)); axis image; title('log10(l2_R__)','Interpreter','none');
set(gca,'XTick',1:n_var_aug,'XTickLabel',string_dat_aug_name_);xtickangle(90);
set(gca,'YTick',1:n_var_aug,'YTickLabel',string_dat_aug_name_);
figbig;

for nvar=0:n_var_aug-1;
c_ = {'r','k'};
subplot(2,1,1); cla;
hold on;
age_base=0;
for naid=0:n_aid-1;
tmp_index_aid_ = index_aid__{1+naid};
tmp_age_ = age_(1+tmp_index_aid_);
[tmp_age_,tmp_index_] = sort(tmp_age_,'ascend'); tmp_index_ = tmp_index_-1;
tmp_var_ = dat_imp__(1+tmp_index_aid_,1+nvar); tmp_var_ = tmp_var_(1+tmp_index_);
plot(age_base+tmp_age_,tmp_var_,'.','Color',c_{1+mod(naid,2)});
age_base = age_base + max(tmp_age_) + 1;
end;%for naid=0:n_aid-1;
hold off;
subplot(2,1,2); cla;
hold on;
dt_all_ = [];
dv_all_ = [];
for naid=0:n_aid-1;
tmp_index_aid_ = index_aid__{1+naid};
tmp_age_ = age_(1+tmp_index_aid_);
[tmp_age_,tmp_index_] = sort(tmp_age_,'ascend'); tmp_index_ = tmp_index_-1;
tmp_var_ = dat_imp__(1+tmp_index_aid_,1+nvar); tmp_var_ = tmp_var_(1+tmp_index_);
dt_ = diff(tmp_age_);
dv_ = diff(tmp_var_);
dt_all_ = [dt_all_;dt_];
dv_all_ = [dv_all_;dv_];
end;%for naid=0:n_aid-1;
plot(dt_all_,dv_all_.^2,'k.');
hold off;
sgtitle(sprintf('%d %s',nvar,string_dat_aug_name_{1+nvar}));
drawnow();
pause();
end;%for nvar=0:n_var_aug-1;

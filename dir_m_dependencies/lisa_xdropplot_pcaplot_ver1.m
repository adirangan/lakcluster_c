%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
% run lisa_xdropplot_initialize and lisa_xdropplot_loadtrace first. ;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
%cl_num_arm2 = 1;
dir__in_arm1 = dir__in;
string_prefix_arm1 = string_prefix;
cl_num_arm1 = cl_num;
nshuffle=0;
string_name_s0000_arm1 = string_name_s0000;
dir_out_s0000_arm1 = dir_out_s0000;
dir_out_s0000_pca_arm1 = sprintf('%s/dir_pca',dir_out_s0000_arm1);
if (~exist(dir_out_s0000_pca_arm1,'dir')); disp(sprintf(' %% creating %s',dir_out_s0000_pca_arm1)); mkdir(dir_out_s0000_pca_arm1); end;
dir_out_trace_arm1 = dir_out_trace;
out_xdrop_a_arm1_ = out_xdrop_a_; rdrop_a_arm1_ = rdrop_a_; cdrop_a_arm1_ = cdrop_a_;
out_xdrop_b_arm1_ = out_xdrop_b_; rdrop_b_arm1_ = rdrop_b_; cdrop_b_arm1_ = cdrop_b_;
bim_arm1_ = bim_;
n_snp_arm1 = n_snp;
fam_arm1_ = fam_;
mr_A_arm1_ = mr_A_;
mr_A_arm1_full = mr_A_full;
mr_Z_arm1_ = mr_Z_;
mr_Z_arm1_full = mr_Z_full;
study_index_arm1_ = study_index_;
iteration_max_arm1 = iteration_max;
r_rem_arm1_ = r_rem_;
c_rem_arm1_ = c_rem_;
niteration_ = 0:25:iteration_max_arm1; 
niteration_(1)=1; niteration_(end) = min(niteration_(end),iteration_max_arm1-1);
niteration_ = niteration_(length(niteration_):-1:1);
pca_b_mlt = 44; pca_tolerance = 1e-2; pca_rank = 2;
flag_verbose=0;

flag_found_all=1;
for ni=1:length(niteration_);
niteration = niteration_(ni);
pca_fname_i = sprintf('%s/i_trn%d_tst%d.mat',dir_out_s0000_pca_arm1,cl_num_arm1,cl_num_arm2);
pca_infix = sprintf('pca_ni%d_tst%d',niteration,cl_num_arm2);
pca_fname_V_arm1_ = sprintf('%s/%s_k%d_B%d_V_.mda',dir_out_s0000_pca_arm1,pca_infix,pca_rank,pca_b_mlt);
pca_fname_V_arm2_ = sprintf('%s/%s_k%d_B%d_V_arm2_.mda',dir_out_s0000_pca_arm1,pca_infix,pca_rank,pca_b_mlt);
pca_proj_arm1_infix = sprintf('pca_proj_arm1_ni%d_tst%d',niteration,cl_num_arm2);
pca_fname_AnV_arm1_ = sprintf('%s/%s_k%d_B%d_AnV_.mda',dir_out_s0000_pca_arm1,pca_proj_arm1_infix,pca_rank,pca_b_mlt);
pca_fname_ZnV_arm1_ = sprintf('%s/%s_k%d_B%d_ZnV_.mda',dir_out_s0000_pca_arm1,pca_proj_arm1_infix,pca_rank,pca_b_mlt);
pca_proj_arm2_infix = sprintf('pca_proj_arm2_ni%d_tst%d',niteration,cl_num_arm2);
pca_fname_AnV_arm2_ = sprintf('%s/%s_k%d_B%d_AnV_.mda',dir_out_s0000_pca_arm1,pca_proj_arm2_infix,pca_rank,pca_b_mlt);
pca_fname_ZnV_arm2_ = sprintf('%s/%s_k%d_B%d_ZnV_.mda',dir_out_s0000_pca_arm1,pca_proj_arm2_infix,pca_rank,pca_b_mlt);
pca_fname_fig = sprintf('%s/%s_pca_proj_ni%d_tst%d.jpg',dir_out_s0000_pca_arm1,string_name_s0000_arm1,niteration,cl_num_arm2); 
if (...
    exist(pca_fname_i,'file') & ...
    exist(pca_fname_V_arm1_,'file') & ...
    exist(pca_fname_V_arm2_,'file') & ...
    exist(pca_fname_AnV_arm1_,'file') & ...
    exist(pca_fname_ZnV_arm1_,'file') & ...
    exist(pca_fname_AnV_arm2_,'file') & ...
    exist(pca_fname_ZnV_arm2_,'file') & ...
    exist(pca_fname_fig,'file') & ...
    1);
if (flag_verbose>1); disp(sprintf(' %% ni %d niteration %d; found:\n%% %s\n%% %s\n%% %s\n%% %s\n%% %s\n%% %s\n%% %s\n%% %s',ni,niteration,pca_fname_i,pca_fname_V_arm1_,pca_fname_V_arm2_,pca_fname_AnV_arm1_,pca_fname_ZnV_arm1_,pca_fname_AnV_arm2_,pca_fname_ZnV_arm2_,pca_fname_fig)); end;% if (flag_verbose>1);
 else;
disp(sprintf(' %% ni %d niteration %d; missing files',ni,niteration));
flag_found_all = flag_found_all*0;
end;% if exist;
end;%for ni=1:length(niteration_);

if (flag_found_all==1); disp(sprintf(' %% pca %s tst%d found all files',string_name_s0000_arm1,cl_num_arm2)); end;% if (flag_found_all==1);

if (flag_found_all==0);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
% intersect columns in arm1 with columns from arm2 (replication arm). ;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
bim_arm1_condensed_ = cell(n_snp_arm1,1);
for nsnp_arm1=1:n_snp_arm1;
bim_arm1_condensed_{nsnp_arm1} = sprintf('%d_%s_%s',bim_arm1_{1}(nsnp_arm1),bim_arm1_{2}{nsnp_arm1},bim_arm1_{7}{nsnp_arm1});
end;%for nsnp_arm1=1:n_snp_arm1;
%%%%%%%%%%%%%%%% ;
string_prefix_arm2 = sprintf('PGC_cl%d_maf01',cl_num_arm2);
dir__in_arm2 = sprintf('%s/dir_%s',dir_trunk,string_prefix_arm2);
dir_out_arm2 = sprintf('%s/dir_%s_analyze',dir_trunk,string_prefix_arm2);
disp(sprintf(' %% cl_num_arm1 %d --> %s versus cl_num_arm2 %d --> %s',cl_num_arm1,string_prefix_arm1,cl_num_arm2,string_prefix_arm2));
[study_trunk_arm2_,study_name_arm2_,n_study_arm2] = lisa_define_study_ver0(cl_num_arm2);
fcheck(sprintf('%s/%s_bim.ext',dir__in_arm2,string_prefix_arm2));
fid = fopen(sprintf('%s/%s_bim.ext',dir__in_arm2,string_prefix_arm2)); 
bim_arm2_ = textscan(fid,'%d\t%s\t%d\t%d\t%c\t%c\t%s\t%f\t%f\t%f\t%f\n','headerlines',0); fclose(fid);
n_snp_arm2 = length(bim_arm2_{1});
bim_arm2_condensed_ = cell(n_snp_arm2,1);
for nsnp_arm2=1:n_snp_arm2;
bim_arm2_condensed_{nsnp_arm2} = sprintf('%d_%s_%s',bim_arm2_{1}(nsnp_arm2),bim_arm2_{2}{nsnp_arm2},bim_arm2_{7}{nsnp_arm2});
end;%for nsnp_arm2=1:n_snp_arm2;
%%%%%%%%%%%%%%%% ;
pca_fname_i = sprintf('%s/i_trn%d_tst%d.mat',dir_out_s0000_pca_arm1,cl_num_arm1,cl_num_arm2);
if ( exist(pca_fname_i,'file')); disp(sprintf(' %% loading %s',pca_fname_i)); load(pca_fname_i); end;
if (~exist(pca_fname_i,'file')); disp(sprintf(' %% creating %s',pca_fname_i)); 
[~,i_arm1,i_arm2] = intersect(bim_arm1_condensed_,bim_arm2_condensed_,'stable');
save(pca_fname_i,'i_arm1','i_arm2');
end;%if (~exist(pca_fname_i,'file'));
disp(sprintf(' %% bim_arm1_condensed_ length %d, bim_arm2_condensed_ length %d, intersection length %d',length(bim_arm1_condensed_),length(bim_arm2_condensed_),length(i_arm1)));
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
% Now set niteration and generate row- and col-masks. ;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
for ni=1:length(niteration_);
niteration = niteration_(ni);

disp(sprintf(' %% ni %d/%d, niteration %d',ni,length(niteration_),niteration));
mr_A_arm1_tmp = mr_A_arm1_full*0; mr_A_arm1_tmp(rdrop_a_arm1_(length(rdrop_a_arm1_)-r_rem_arm1_(niteration)+1:length(rdrop_a_arm1_)))=1;
tmpchar = sprintf('%s/%s_mc_A.b16',dir_out_s0000_arm1,string_name_s0000_arm1); 
[bitj,nrows,ncols] = tutorial_binary_getsize(tmpchar); mc_A_arm1 = tutorial_binary_uncompress(tmpchar,1:nrows,1:ncols)>0;
mc_A_arm1_tmp = mc_A_arm1*0; mc_A_arm1_tmp(cdrop_a_arm1_(length(cdrop_a_arm1_)-c_rem_arm1_(niteration)+1:length(cdrop_a_arm1_)))=1;
%%%%%%%%%%%%%%%% ;
% mc_A_arm1_cap contains columns for arm1. ;
%%%%%%%%%%%%%%%% ;
[~,ii] = intersect(i_arm1,find(mc_A_arm1_tmp),'stable');
disp(sprintf(' %% ii length %d',length(ii)));
for nc=1:length(ii); assert(strcmp(bim_arm2_condensed_{i_arm2(ii(nc))},bim_arm1_condensed_{i_arm1(ii(nc))})); end;%for nc=1:length(ii);
mc_A_arm1_cap = mc_A_arm1*0; mc_A_arm1_cap(i_arm1(ii))=1;
%%%%%%%%%%%%%%%% ;
% mc_A_arm2_cap contains columns for replication arm. ;
%%%%%%%%%%%%%%%% ;
tmpchar = sprintf('%s/PGC_cl%d_maf01_mc_A.b16',dir__in_arm2,cl_num_arm2);
[bitj,nrows,ncols] = tutorial_binary_getsize(tmpchar); mc_A_arm2 = tutorial_binary_uncompress(tmpchar,1:nrows,1:ncols)>0;
mc_A_arm2_cap = mc_A_arm2*0; mc_A_arm2_cap(i_arm2(ii))=1;
j_ = find(mc_A_arm1_cap); j_arm2_ = find(mc_A_arm2_cap); assert(length(j_)==length(j_arm2_));
assert(length(intersect(bim_arm2_condensed_(j_arm2_),bim_arm1_condensed_(j_)))==length(j_));
%%%%%%%%%%%%%%%% ;
pca_infix = sprintf('pca_ni%d_tst%d',niteration,cl_num_arm2);
%%%%%%%%%%%%%%%% ;
% Assuming Icat==1 (i.e., full) for single row mask. ;
tmpchar = sprintf('%s/%s_mr_A_arm1_full_%s.b16',dir_out_s0000_pca_arm1,string_name_s0000_arm1,pca_infix); %delete(tmpchar);
tutorial_binary_compress(bitj,mr_A_arm1_tmp(:)>0,tmpchar);
tmpchar = sprintf('%s/%s_mc_A_arm1_%s.b16',dir_out_s0000_pca_arm1,string_name_s0000_arm1,pca_infix); %delete(tmpchar);
tutorial_binary_compress(bitj,mc_A_arm1_cap(:)>0,tmpchar);
tmpchar = sprintf('%s/%s_mc_A_arm2_%s.b16',dir_out_s0000_pca_arm1,string_name_s0000_arm1,pca_infix); %delete(tmpchar);
tutorial_binary_compress(bitj,mc_A_arm2_cap(:)>0,tmpchar);
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%pca_b_mlt = 44; pca_tolerance = 1e-2; pca_rank = 2;
pca_fname_V_arm1_ = sprintf('%s/%s_k%d_B%d_V_.mda',dir_out_s0000_pca_arm1,pca_infix,pca_rank,pca_b_mlt);
if ( exist(pca_fname_V_arm1_,'file'));
disp(sprintf(' %% loading %s',pca_fname_V_arm1_));
end;%if ( exist(pca_fname_V_arm1_,'file'));
if (~exist(pca_fname_V_arm1_,'file'));
disp(sprintf(' %% calculating %s',pca_fname_V_arm1_));
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
% setting up input file for pca_driver. ;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
nshuffle=0;
d_inpre = sprintf('%s/%s',dir__in_arm1,string_prefix_arm1); 
d_oupre = sprintf('%s/%s',dir_out_s0000_arm1,string_name_s0000_arm1);
d_oupre_pca = sprintf('%s/%s',dir_out_s0000_pca_arm1,string_name_s0000_arm1);
%pca_b_mlt = 44;
%pca_tolerance = 1e-2;
%pca_rank = 2;
flag_T = 1;
mds_str = sprintf('m%dr%d',length(mds_used_),mds_repl);
mds_kappa_squared = textread(sprintf('%s_T_%s_kappa.txt',d_inpre,mds_str));
T_n_cols = 1+length(mds_used_)*mds_repl;
Y_n_cols=0;
M_n_rows_ = zeros(Icat,1); M_n_cols = length(mc_A_arm1);
for nb=0:Icat-1; M_n_rows_(1+nb) = length(mr_A_arm1_{1+nb});end;%for nb=0:Icat-1;
pca_infix = sprintf('pca_ni%d_tst%d',niteration,cl_num_arm2);
fname__in = sprintf('%s/%s_%s.in',dir_out_s0000_pca_arm1,string_name_s0000_arm1,pca_infix);
fp = fopen(fname__in,'w');
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
fprintf(fp,'GLOBAL_verbose= %d;\n',flag_verbose);
fprintf(fp,'GLOBAL_thread_count= 15;\n');
fprintf(fp,'GLOBAL_omp_type= 1;\n');
fprintf(fp,'GLOBAL_TEST_TYPE= %s;\n','pca_driver');
fprintf(fp,'GLOBAL_pca_infix= %s;\n',pca_infix);
fprintf(fp,'GLOBAL_pca_iteration_num= 1;\n');
fprintf(fp,'GLOBAL_pca_iteration_max= 0;\n');
fprintf(fp,'GLOBAL_pca_iteration_min= 0;\n');
fprintf(fp,'GLOBAL_pca_rank= %d;\n',pca_rank);
fprintf(fp,'GLOBAL_pca_tolerance= %0.16f;\n',pca_tolerance);
fprintf(fp,'GLOBAL_TEST_niter= 1024;\n');
fprintf(fp,'GLOBAL_NBINS= %d;\n',Icat);
fprintf(fp,'GLOBAL_B_MLT= %d;\n',pca_b_mlt);
fprintf(fp,'GLOBAL_gamma= %0.4f;\n',gamma);
fprintf(fp,'GLOBAL_Ireq= %d;\n',Ireq);
if (flag_T==1); fprintf(fp,'GLOBAL_kappa_squared= %0.16f;\n',mds_kappa_squared); end;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
if (nshuffle==0); A_name_string = '_A_'; end;%if (nshuffle==0);
if (nshuffle>0); A_name_string = '_A_shuffle_'; end;%if (nshuffle>0);
dexcluster_PGC_uADZSZDA_excerpt_0(fp,'GLOBAL_A_n_name_= ',Icat,d_inpre,A_name_string,'_n.b16');
dexcluster_PGC_uADZSZDA_excerpt_0(fp,'GLOBAL_A_t_name_= ',Icat,d_inpre,A_name_string,'_t.b16');
dexcluster_PGC_uADZSZDA_excerpt_1(fp,'GLOBAL_A_n_rows_= ',Icat,M_n_rows_);
fprintf(fp,'GLOBAL_A_n_cols= %d;\n',M_n_cols);
if (flag_reverse==1); dexcluster_PGC_uADZSZDA_excerpt_0(fp,'GLOBAL_A_n_rind_= ',Icat,d_oupre_pca,'_mr_Z_arm1_',sprintf('_%s.b16',pca_infix)); end;
if (flag_reverse==0); dexcluster_PGC_uADZSZDA_excerpt_0(fp,'GLOBAL_A_n_rind_= ',Icat,d_oupre_pca,'_mr_A_arm1_',sprintf('_%s.b16',pca_infix)); end;
fprintf(fp,'GLOBAL_A_n_cind= %s_mc_A_arm1_%s.b16;\n',d_oupre_pca,pca_infix);
fprintf(fp,'GLOBAL_A_p_name= %s/A_p.mda;\n',dir_out_s0000_arm1);
dexcluster_PGC_uADZSZDA_excerpt_0(fp,'GLOBAL_Z_n_name_= ',Icat,d_inpre,A_name_string,'_n.b16');
dexcluster_PGC_uADZSZDA_excerpt_0(fp,'GLOBAL_Z_t_name_= ',Icat,d_inpre,A_name_string,'_t.b16');
dexcluster_PGC_uADZSZDA_excerpt_1(fp,'GLOBAL_Z_n_rows_= ',Icat,M_n_rows_);
if (flag_reverse==1); dexcluster_PGC_uADZSZDA_excerpt_0(fp,'GLOBAL_Z_n_rind_= ',Icat,d_oupre,'_mr_A_','.b16'); end;
if (flag_reverse==0); dexcluster_PGC_uADZSZDA_excerpt_0(fp,'GLOBAL_Z_n_rind_= ',Icat,d_oupre,'_mr_Z_','.b16'); end;
fprintf(fp,'GLOBAL_Y_n_cols= %d;\n',Y_n_cols);
if (flag_T==0);
fprintf(fp,'GLOBAL_T_n_cols= %d;\n',T_n_crop_cols); 
dexcluster_PGC_uADZSZDA_excerpt_0(fp,'GLOBAL_T_n_name_= ',Icat,d_oupre,'_T_crop_','_n.b16');
dexcluster_PGC_uADZSZDA_excerpt_0(fp,'GLOBAL_T_t_name_= ',Icat,d_oupre,'_T_crop_','_t.b16');
fprintf(fp,'GLOBAL_T_n_cind= %s_mc_T_crop.b16;\n',d_oupre);
dexcluster_PGC_uADZSZDA_excerpt_0(fp,'GLOBAL_S_n_name_= ',Icat,d_oupre,'_T_crop_','_n.b16');
dexcluster_PGC_uADZSZDA_excerpt_0(fp,'GLOBAL_S_t_name_= ',Icat,d_oupre,'_T_crop_','_t.b16');
end;%if (flag_T==0);
if (flag_T==1);
fprintf(fp,'GLOBAL_T_n_cols= %d;\n',T_n_cols); 
dexcluster_PGC_uADZSZDA_excerpt_0(fp,'GLOBAL_T_n_name_= ',Icat,d_inpre,sprintf('_T_%s_',mds_str),'_n.b16');
dexcluster_PGC_uADZSZDA_excerpt_0(fp,'GLOBAL_T_t_name_= ',Icat,d_inpre,sprintf('_T_%s_',mds_str),'_t.b16');
fprintf(fp,'GLOBAL_T_n_cind= %s_mc_T_%s.b16;\n',d_oupre,mds_str);
dexcluster_PGC_uADZSZDA_excerpt_0(fp,'GLOBAL_S_n_name_= ',Icat,d_inpre,sprintf('_T_%s_',mds_str),'_n.b16');
dexcluster_PGC_uADZSZDA_excerpt_0(fp,'GLOBAL_S_t_name_= ',Icat,d_inpre,sprintf('_T_%s_',mds_str),'_t.b16');
end;%if (flag_T==1);
fprintf(fp,'GLOBAL_DIR_NAME= %s;\n',dir_out_s0000_pca_arm1);
fprintf(fp,'END= 0;\n');
fprintf(fp,'%% generated by pca_PGC_uADZSZDA_ver0.m on %s;\n',date);
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
fclose(fp);
type(fname__in);
disp(sprintf(' %% fname__in:\n%s',fname__in));
command_str = sprintf('%s/lakcluster_ver18 < %s',dir_code,fname__in);
system(command_str);
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
end;%if (~exist(pca_fname_V_arm1_,'file'));

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
% Now load V_arm1_ and generate pca for arm2. ;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
V_arm1_ = mda_read_r8(pca_fname_V_arm1_);
for (nr=1:pca_rank); assert(sum(V_arm1_(:,nr)~=0)<=length(mc_A_arm1_cap)); assert(sum(V_arm1_(:,nr))==sum(V_arm1_(:,nr).*mc_A_arm1_cap)); end;
V_arm2_ = zeros(length(mc_A_arm2),pca_rank);
for nc=1:length(ii); V_arm2_(i_arm2(ii(nc)),:) = V_arm1_(i_arm1(ii(nc)),:); end;%for nc=1:length(ii);
for (nr=1:pca_rank); assert(sum(V_arm2_(:,nr)~=0)<=length(mc_A_arm2_cap)); assert(sum(V_arm2_(:,nr))==sum(V_arm2_(:,nr).*mc_A_arm2_cap)); end;
pca_fname_V_arm2_ = sprintf('%s/%s_k%d_B%d_V_arm2_.mda',dir_out_s0000_pca_arm1,pca_infix,pca_rank,pca_b_mlt);
mda_write_d3_r8(V_arm2_,pca_fname_V_arm2_);

pca_proj_arm1_infix = sprintf('pca_proj_arm1_ni%d_tst%d',niteration,cl_num_arm2);
pca_fname_AnV_arm1_ = sprintf('%s/%s_k%d_B%d_AnV_.mda',dir_out_s0000_pca_arm1,pca_proj_arm1_infix,pca_rank,pca_b_mlt);
pca_fname_ZnV_arm1_ = sprintf('%s/%s_k%d_B%d_ZnV_.mda',dir_out_s0000_pca_arm1,pca_proj_arm1_infix,pca_rank,pca_b_mlt);
if ( exist(pca_fname_AnV_arm1_,'file') &  exist(pca_fname_ZnV_arm1_,'file'));
disp(sprintf(' %% loading %s and %s',pca_fname_AnV_arm1_,pca_fname_ZnV_arm1_));
end;%if ( exist(pca_fname_AnV_arm1_,'file') &  exist(pca_fname_ZnV_arm1_,'file'));
if (~exist(pca_fname_AnV_arm1_,'file') | ~exist(pca_fname_ZnV_arm1_,'file'));
disp(sprintf(' %% calculating %s and %s',pca_fname_AnV_arm1_,pca_fname_ZnV_arm1_));
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
% setting up input file for pca_proj arm1. ;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
nshuffle=0;
d_inpre = sprintf('%s/%s',dir__in_arm1,string_prefix_arm1); 
d_oupre = sprintf('%s/%s',dir_out_s0000_arm1,string_name_s0000_arm1);
d_oupre_pca = sprintf('%s/%s',dir_out_s0000_pca_arm1,string_name_s0000_arm1);
%pca_b_mlt = 44;
%pca_tolerance = 1e-2;
%pca_rank = 2;
mds_str = sprintf('m%dr%d',length(mds_used_),mds_repl);
Y_n_cols=0;
M_n_rows_ = zeros(Icat,1); M_n_cols = length(mc_A_arm1);
for nb=0:Icat-1; M_n_rows_(1+nb) = length(mr_A_arm1_{1+nb});end;%for nb=0:Icat-1;
pca_proj_arm1_infix = sprintf('pca_proj_arm1_ni%d_tst%d',niteration,cl_num_arm2);
fname__in = sprintf('%s/%s_%s.in',dir_out_s0000_pca_arm1,string_name_s0000_arm1,pca_proj_arm1_infix);
fp = fopen(fname__in,'w');
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
fprintf(fp,'GLOBAL_verbose= %d;\n',flag_verbose);
fprintf(fp,'GLOBAL_thread_count= 15;\n');
fprintf(fp,'GLOBAL_omp_type= 1;\n');
fprintf(fp,'GLOBAL_TEST_TYPE= %s;\n','pca_proj_driver');
fprintf(fp,'GLOBAL_pca_infix= %s;\n',pca_proj_arm1_infix);
fprintf(fp,'GLOBAL_pca_V_= %s;\n',pca_fname_V_arm1_);
fprintf(fp,'GLOBAL_pca_iteration_num= 1;\n');
fprintf(fp,'GLOBAL_pca_iteration_max= 0;\n');
fprintf(fp,'GLOBAL_pca_iteration_min= 0;\n');
fprintf(fp,'GLOBAL_pca_rank= %d;\n',pca_rank);
fprintf(fp,'GLOBAL_pca_tolerance= %0.16f;\n',pca_tolerance);
fprintf(fp,'GLOBAL_TEST_niter= 1024;\n');
fprintf(fp,'GLOBAL_NBINS= %d;\n',Icat);
fprintf(fp,'GLOBAL_B_MLT= %d;\n',pca_b_mlt);
fprintf(fp,'GLOBAL_gamma= %0.4f;\n',gamma);
fprintf(fp,'GLOBAL_Ireq= %d;\n',Ireq);
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
if (nshuffle==0); A_name_string = '_A_'; end;%if (nshuffle==0);
if (nshuffle>0); A_name_string = '_A_shuffle_'; end;%if (nshuffle>0);
dexcluster_PGC_uADZSZDA_excerpt_0(fp,'GLOBAL_A_n_name_= ',Icat,d_inpre,A_name_string,'_n.b16');
dexcluster_PGC_uADZSZDA_excerpt_0(fp,'GLOBAL_A_t_name_= ',Icat,d_inpre,A_name_string,'_t.b16');
dexcluster_PGC_uADZSZDA_excerpt_1(fp,'GLOBAL_A_n_rows_= ',Icat,M_n_rows_);
fprintf(fp,'GLOBAL_A_n_cols= %d;\n',M_n_cols);
if (flag_reverse==1); dexcluster_PGC_uADZSZDA_excerpt_0(fp,'GLOBAL_A_n_rind_= ',Icat,d_oupre,'_mr_Z_','.b16'); end;
if (flag_reverse==0); dexcluster_PGC_uADZSZDA_excerpt_0(fp,'GLOBAL_A_n_rind_= ',Icat,d_oupre,'_mr_A_','.b16'); end;
fprintf(fp,'GLOBAL_A_n_cind= %s_mc_A_arm1_%s.b16;\n',d_oupre_pca,pca_infix);
fprintf(fp,'GLOBAL_A_p_name= %s/A_p.mda;\n',dir_out_s0000_arm1);
dexcluster_PGC_uADZSZDA_excerpt_0(fp,'GLOBAL_Z_n_name_= ',Icat,d_inpre,A_name_string,'_n.b16');
dexcluster_PGC_uADZSZDA_excerpt_0(fp,'GLOBAL_Z_t_name_= ',Icat,d_inpre,A_name_string,'_t.b16');
dexcluster_PGC_uADZSZDA_excerpt_1(fp,'GLOBAL_Z_n_rows_= ',Icat,M_n_rows_);
if (flag_reverse==1); dexcluster_PGC_uADZSZDA_excerpt_0(fp,'GLOBAL_Z_n_rind_= ',Icat,d_oupre,'_mr_A_','.b16'); end;
if (flag_reverse==0); dexcluster_PGC_uADZSZDA_excerpt_0(fp,'GLOBAL_Z_n_rind_= ',Icat,d_oupre,'_mr_Z_','.b16'); end;
fprintf(fp,'GLOBAL_Y_n_cols= %d;\n',Y_n_cols);
fprintf(fp,'GLOBAL_DIR_NAME= %s;\n',dir_out_s0000_pca_arm1);
fprintf(fp,'END= 0;\n');
fprintf(fp,'%% generated by pca_PGC_uADZSZDA_ver0.m on %s;\n',date);
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
fclose(fp);
type(fname__in);
disp(sprintf(' %% fname__in:\n%s',fname__in));
command_str = sprintf('%s/lakcluster_ver18 < %s',dir_code,fname__in);
system(command_str);
end;%if (~exist(pca_fname_AnV_arm1_,'file') | ~exist(pca_fname_ZnV_arm1_,'file'));

%%%%%%%%%%%%%%%%;
tmpchar = sprintf('%s/PGC_cl%d_maf01_mr_A_full.b16',dir__in_arm2,cl_num_arm2);
[bitj,nrows,ncols] = tutorial_binary_getsize(tmpchar); mr_A_arm2_full = tutorial_binary_uncompress(tmpchar,1:nrows,1:ncols)>0;
tmpchar = sprintf('%s/PGC_cl%d_maf01_mr_Z_full.b16',dir__in_arm2,cl_num_arm2);
[bitj,nrows,ncols] = tutorial_binary_getsize(tmpchar); mr_Z_arm2_full = tutorial_binary_uncompress(tmpchar,1:nrows,1:ncols)>0;
%%%%%%%%%%%%%%%%;
pca_proj_arm2_infix = sprintf('pca_proj_arm2_ni%d_tst%d',niteration,cl_num_arm2);
pca_fname_AnV_arm2_ = sprintf('%s/%s_k%d_B%d_AnV_.mda',dir_out_s0000_pca_arm1,pca_proj_arm2_infix,pca_rank,pca_b_mlt);
pca_fname_ZnV_arm2_ = sprintf('%s/%s_k%d_B%d_ZnV_.mda',dir_out_s0000_pca_arm1,pca_proj_arm2_infix,pca_rank,pca_b_mlt);
if ( exist(pca_fname_AnV_arm2_,'file') &  exist(pca_fname_ZnV_arm2_,'file'));
disp(sprintf(' %% loading %s and %s',pca_fname_AnV_arm2_,pca_fname_ZnV_arm2_));
end;%if ( exist(pca_fname_AnV_arm2_,'file') &  exist(pca_fname_ZnV_arm2_,'file'));
if (~exist(pca_fname_AnV_arm2_,'file') | ~exist(pca_fname_ZnV_arm2_,'file'));
disp(sprintf(' %% calculating %s and %s',pca_fname_AnV_arm2_,pca_fname_ZnV_arm2_));
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
% setting up input file for pca_proj arm2. ;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
nshuffle=0;
d_inpre_arm2 = sprintf('%s/%s',dir__in_arm2,string_prefix_arm2); 
d_oupre = sprintf('%s/%s',dir_out_s0000_arm1,string_name_s0000_arm1);
d_oupre_pca = sprintf('%s/%s',dir_out_s0000_pca_arm1,string_name_s0000_arm1);
%pca_b_mlt = 44;
%pca_tolerance = 1e-2;
%pca_rank = 2;
mds_str = sprintf('m%dr%d',length(mds_used_),mds_repl);
Y_n_cols=0;
Icat = 1; M_n_rows_ = length(mr_A_arm2_full);
M_n_cols = length(mc_A_arm2);
fname__in = sprintf('%s/%s_%s.in',dir_out_s0000_pca_arm1,string_name_s0000_arm1,pca_proj_arm2_infix);
fp = fopen(fname__in,'w');
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
fprintf(fp,'GLOBAL_verbose= %d;\n',flag_verbose);
fprintf(fp,'GLOBAL_thread_count= 15;\n');
fprintf(fp,'GLOBAL_omp_type= 1;\n');
fprintf(fp,'GLOBAL_TEST_TYPE= %s;\n','pca_proj_driver');
fprintf(fp,'GLOBAL_pca_infix= %s;\n',pca_proj_arm2_infix);
fprintf(fp,'GLOBAL_pca_V_= %s;\n',pca_fname_V_arm2_);
fprintf(fp,'GLOBAL_pca_iteration_num= 1;\n');
fprintf(fp,'GLOBAL_pca_iteration_max= 0;\n');
fprintf(fp,'GLOBAL_pca_iteration_min= 0;\n');
fprintf(fp,'GLOBAL_pca_rank= %d;\n',pca_rank);
fprintf(fp,'GLOBAL_pca_tolerance= %0.16f;\n',pca_tolerance);
fprintf(fp,'GLOBAL_TEST_niter= 1024;\n');
fprintf(fp,'GLOBAL_NBINS= %d;\n',Icat);
fprintf(fp,'GLOBAL_B_MLT= %d;\n',pca_b_mlt);
fprintf(fp,'GLOBAL_gamma= %0.4f;\n',gamma);
fprintf(fp,'GLOBAL_Ireq= %d;\n',Ireq);
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
if (nshuffle==0); A_name_string = '_A_'; end;%if (nshuffle==0);
if (nshuffle>0); A_name_string = '_A_shuffle_'; end;%if (nshuffle>0);
dexcluster_PGC_uADZSZDA_excerpt_0(fp,'GLOBAL_A_n_name_= ',Icat,d_inpre_arm2,A_name_string,'_n.b16');
dexcluster_PGC_uADZSZDA_excerpt_0(fp,'GLOBAL_A_t_name_= ',Icat,d_inpre_arm2,A_name_string,'_t.b16');
dexcluster_PGC_uADZSZDA_excerpt_1(fp,'GLOBAL_A_n_rows_= ',Icat,M_n_rows_);
fprintf(fp,'GLOBAL_A_n_cols= %d;\n',M_n_cols);
if (flag_reverse==1); dexcluster_PGC_uADZSZDA_excerpt_0(fp,'GLOBAL_A_n_rind_= ',Icat,d_inpre_arm2,'_mr_Z_','.b16'); end;
if (flag_reverse==0); dexcluster_PGC_uADZSZDA_excerpt_0(fp,'GLOBAL_A_n_rind_= ',Icat,d_inpre_arm2,'_mr_A_','.b16'); end;
fprintf(fp,'GLOBAL_A_n_cind= %s_mc_A_arm2_%s.b16;\n',d_oupre_pca,pca_infix);
dexcluster_PGC_uADZSZDA_excerpt_0(fp,'GLOBAL_Z_n_name_= ',Icat,d_inpre_arm2,A_name_string,'_n.b16');
dexcluster_PGC_uADZSZDA_excerpt_0(fp,'GLOBAL_Z_t_name_= ',Icat,d_inpre_arm2,A_name_string,'_t.b16');
dexcluster_PGC_uADZSZDA_excerpt_1(fp,'GLOBAL_Z_n_rows_= ',Icat,M_n_rows_);
if (flag_reverse==1); dexcluster_PGC_uADZSZDA_excerpt_0(fp,'GLOBAL_Z_n_rind_= ',Icat,d_inpre_arm2,'_mr_A_','.b16'); end;
if (flag_reverse==0); dexcluster_PGC_uADZSZDA_excerpt_0(fp,'GLOBAL_Z_n_rind_= ',Icat,d_inpre_arm2,'_mr_Z_','.b16'); end;
fprintf(fp,'GLOBAL_Y_n_cols= %d;\n',Y_n_cols);
fprintf(fp,'GLOBAL_DIR_NAME= %s;\n',dir_out_s0000_pca_arm1);
fprintf(fp,'END= 0;\n');
fprintf(fp,'%% generated by pca_PGC_uADZSZDA_ver0.m on %s;\n',date);
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
fclose(fp);
type(fname__in);
disp(sprintf(' %% fname__in:\n%s',fname__in));
command_str = sprintf('%s/lakcluster_ver18 < %s',dir_code,fname__in);
system(command_str);
end;%if (~exist(pca_fname_AnV_arm2_,'file') | ~exist(pca_fname_ZnV_arm2_,'file'));

pca_fname_fig = sprintf('%s/%s_pca_proj_ni%d_tst%d.jpg',dir_out_s0000_pca_arm1,string_name_s0000_arm1,niteration,cl_num_arm2); 
if ( exist(pca_fname_fig,'file')); end;
if (~exist(pca_fname_fig,'file'));
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
% plot results. ;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
mr_A_arm1_tmp = mr_A_arm1_full*0; mr_A_arm1_tmp(rdrop_a_arm1_(length(rdrop_a_arm1_)-r_rem_arm1_(niteration)+1:length(rdrop_a_arm1_)))=1;
%figure(ni);clf;
figure(1);clf;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
AnV_arm1_ = mda_read_r8(pca_fname_AnV_arm1_);
ZnV_arm1_ = mda_read_r8(pca_fname_ZnV_arm1_);
subplot(2,2,1);hold on; 
plot(ZnV_arm1_(find(mr_Z_arm1_full),1),ZnV_arm1_(find(mr_Z_arm1_full),2),'k.','MarkerSize',15);
plot(AnV_arm1_(find(mr_A_arm1_full-mr_A_arm1_tmp),1),AnV_arm1_(find(mr_A_arm1_full-mr_A_arm1_tmp),2),'g.','MarkerSize',15);
plot(AnV_arm1_(find(mr_A_arm1_tmp),1),AnV_arm1_(find(mr_A_arm1_tmp),2),'r.','MarkerSize',25);
hold off;
xlabel('PC1');ylabel('PC2'); title(sprintf('ni %d arm1',niteration));
subplot(2,2,2); hold on;
hlim = mean(union(ZnV_arm1_(:,1),AnV_arm1_(:,1))) + [-1,1]*3.5*std(union(ZnV_arm1_(:,1),AnV_arm1_(:,1)));
if (min(hlim)>=max(hlim)); hlim = mean(hlim) + [-1,+1]; end;
hbins=linspace(min(hlim),max(hlim),64);
h_Z_full = hist(ZnV_arm1_(find(mr_Z_arm1_full),1),hbins); h_Z_full = h_Z_full/sum(mr_Z_arm1_full);
h_A_full = hist(AnV_arm1_(find(mr_A_arm1_full),1),hbins); h_A_full = h_A_full/sum(mr_A_arm1_full);
h_A_exc = hist(AnV_arm1_(find(mr_A_arm1_full-mr_A_arm1_tmp),1),hbins); h_A_exc = h_A_exc/sum(mr_A_arm1_full);
h_A_tmp = hist(AnV_arm1_(find(mr_A_arm1_tmp),1),hbins); h_A_tmp = h_A_tmp/sum(mr_A_arm1_full);
stairs(hbins,h_Z_full,'k-','LineWidth',2);
stairs(hbins,h_A_full,'m-','LineWidth',2);
stairs(hbins,h_A_exc,'g-','LineWidth',2);
stairs(hbins,h_A_tmp,'r-','LineWidth',2);
hold off;
xlim(hlim);xlabel('PC1');ylabel('hist'); title(sprintf('ni %d arm1',niteration));
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
AnV_arm2_ = mda_read_r8(pca_fname_AnV_arm2_);
ZnV_arm2_ = mda_read_r8(pca_fname_ZnV_arm2_);
subplot(2,2,3);hold on; 
plot(ZnV_arm2_(find(mr_Z_arm2_full),1),ZnV_arm2_(find(mr_Z_arm2_full),2),'k.','MarkerSize',15);
plot(AnV_arm2_(find(mr_A_arm2_full),1),AnV_arm2_(find(mr_A_arm2_full),2),'m.','MarkerSize',15);
hold off;
xlabel('PC1');ylabel('PC2'); title(sprintf('ni %d arm2',niteration));
subplot(2,2,4); hold on;
hlim = mean(union(ZnV_arm2_(:,1),AnV_arm2_(:,1))) + [-1,1]*3.5*std(union(ZnV_arm2_(:,1),AnV_arm2_(:,1)));
if (min(hlim)>=max(hlim)); hlim = mean(hlim) + [-1,+1]; end;
hbins=linspace(min(hlim),max(hlim),64);
h_Z_full = hist(ZnV_arm2_(find(mr_Z_arm2_full),1),hbins); h_Z_full = h_Z_full/sum(mr_Z_arm2_full);
h_A_full = hist(AnV_arm2_(find(mr_A_arm2_full),1),hbins); h_A_full = h_A_full/sum(mr_A_arm2_full);
stairs(hbins,h_Z_full,'k-','LineWidth',2);
stairs(hbins,h_A_full,'m-','LineWidth',2);
hold off;
xlim(hlim);xlabel('PC1');ylabel('hist'); title(sprintf('ni %d arm2',niteration));
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
set(gcf,'Position',1+[0,0,1024*2,1024]);
drawnow();
print('-djpeg',pca_fname_fig);
end;%if (~exist(pca_fname_fig,'file'));

end;%for ni=1:length(niteration_);

end;%if (flag_found_all==0);

function [zone_max,zone_max_index] = Z_imax_zerobased(verbose,Z_,Z_min);
% finds interior maximum of Z_;
if nargin<1;
verbose=1;
n_x = 1024; x_ = linspace(0,2*pi,n_x);
figure(2);clf;figbig;
prows=4;pcols=5;np=1;
Z_ = exp(0.00-x_); [Z,Z_index] = Z_imax_zerobased(0,Z_,0); subplot(prows,pcols,np); plot(x_,Z_,'k.-',x_(1+Z_index),Z,'ro',x_,zeros(n_x,1),'k:'); xlim([0,2*pi]); np=np+1; disp(sprintf(" %% Z %0.16f Z_index %d",Z,Z_index));
Z_ = exp(x_-2*pi); [Z,Z_index] = Z_imax_zerobased(0,Z_,0); subplot(prows,pcols,np); plot(x_,Z_,'k.-',x_(1+Z_index),Z,'ro',x_,zeros(n_x,1),'k:'); xlim([0,2*pi]); np=np+1; disp(sprintf(" %% Z %0.16f Z_index %d",Z,Z_index));
Z_ = exp(0.00-x_).*sin(x_); [Z,Z_index] = Z_imax_zerobased(0,Z_,0); subplot(prows,pcols,np); plot(x_,Z_,'k.-',x_(1+Z_index),Z,'ro',x_,zeros(n_x,1),'k:'); xlim([0,2*pi]); np=np+1; disp(sprintf(" %% Z %0.16f Z_index %d",Z,Z_index));
Z_ = exp(x_-2*pi).*sin(x_); [Z,Z_index] = Z_imax_zerobased(0,Z_,0); subplot(prows,pcols,np); plot(x_,Z_,'k.-',x_(1+Z_index),Z,'ro',x_,zeros(n_x,1),'k:'); xlim([0,2*pi]); np=np+1; disp(sprintf(" %% Z %0.16f Z_index %d",Z,Z_index));
Z_ = exp(0.00-x_).*cos(x_); [Z,Z_index] = Z_imax_zerobased(0,Z_,0); subplot(prows,pcols,np); plot(x_,Z_,'k.-',x_(1+Z_index),Z,'ro',x_,zeros(n_x,1),'k:'); xlim([0,2*pi]); np=np+1; disp(sprintf(" %% Z %0.16f Z_index %d",Z,Z_index));
Z_ = exp(x_-2*pi).*cos(x_); [Z,Z_index] = Z_imax_zerobased(0,Z_,0); subplot(prows,pcols,np); plot(x_,Z_,'k.-',x_(1+Z_index),Z,'ro',x_,zeros(n_x,1),'k:'); xlim([0,2*pi]); np=np+1; disp(sprintf(" %% Z %0.16f Z_index %d",Z,Z_index));
Z_ = cos(x_)+2; [Z,Z_index] = Z_imax_zerobased(0,Z_,0); subplot(prows,pcols,np); plot(x_,Z_,'k.-',x_(1+Z_index),Z,'ro',x_,zeros(n_x,1),'k:'); xlim([0,2*pi]); np=np+1; disp(sprintf(" %% Z %0.16f Z_index %d",Z,Z_index));
Z_ = (x_-pi).^2; [Z,Z_index] = Z_imax_zerobased(0,Z_,0); subplot(prows,pcols,np); plot(x_,Z_,'k.-',x_(1+Z_index),Z,'ro',x_,zeros(n_x,1),'k:'); xlim([0,2*pi]); np=np+1; disp(sprintf(" %% Z %0.16f Z_index %d",Z,Z_index));
Z_ = exp(0.00-x_)+0.15*cos(3*x_); [Z,Z_index] = Z_imax_zerobased(0,Z_,0); subplot(prows,pcols,np); plot(x_,Z_,'k.-',x_(1+Z_index),Z,'ro',x_,zeros(n_x,1),'k:'); xlim([0,2*pi]); np=np+1; disp(sprintf(" %% Z %0.16f Z_index %d",Z,Z_index));
Z_ = exp(x_-2*pi)+0.15*cos(3*x_); [Z,Z_index] = Z_imax_zerobased(0,Z_,0); subplot(prows,pcols,np); plot(x_,Z_,'k.-',x_(1+Z_index),Z,'ro',x_,zeros(n_x,1),'k:'); xlim([0,2*pi]); np=np+1; disp(sprintf(" %% Z %0.16f Z_index %d",Z,Z_index));
Z_ = exp(0.00-x_)+0.15*sin(3*x_); [Z,Z_index] = Z_imax_zerobased(0,Z_,0); subplot(prows,pcols,np); plot(x_,Z_,'k.-',x_(1+Z_index),Z,'ro',x_,zeros(n_x,1),'k:'); xlim([0,2*pi]); np=np+1; disp(sprintf(" %% Z %0.16f Z_index %d",Z,Z_index));
Z_ = exp(x_-2*pi)+0.15*sin(3*x_); [Z,Z_index] = Z_imax_zerobased(0,Z_,0); subplot(prows,pcols,np); plot(x_,Z_,'k.-',x_(1+Z_index),Z,'ro',x_,zeros(n_x,1),'k:'); xlim([0,2*pi]); np=np+1; disp(sprintf(" %% Z %0.16f Z_index %d",Z,Z_index));
Z_ = exp(0.00-x_)+0.1*sin(3*x_)+1; [Z,Z_index] = Z_imax_zerobased(0,Z_,0); subplot(prows,pcols,np); plot(x_,Z_,'k.-',x_(1+Z_index),Z,'ro',x_,zeros(n_x,1),'k:'); xlim([0,2*pi]); np=np+1; disp(sprintf(" %% Z %0.16f Z_index %d",Z,Z_index));
Z_ = exp(x_-2*pi)+0.1*sin(3*x_)+1; [Z,Z_index] = Z_imax_zerobased(0,Z_,0); subplot(prows,pcols,np); plot(x_,Z_,'k.-',x_(1+Z_index),Z,'ro',x_,zeros(n_x,1),'k:'); xlim([0,2*pi]); np=np+1; disp(sprintf(" %% Z %0.16f Z_index %d",Z,Z_index));
Z_ = exp(0.00-x_)+0.1*cos(3*x_)+1; [Z,Z_index] = Z_imax_zerobased(0,Z_,0); subplot(prows,pcols,np); plot(x_,Z_,'k.-',x_(1+Z_index),Z,'ro',x_,zeros(n_x,1),'k:'); xlim([0,2*pi]); np=np+1; disp(sprintf(" %% Z %0.16f Z_index %d",Z,Z_index));
Z_ = exp(x_-2*pi)+0.1*cos(3*x_)+1; [Z,Z_index] = Z_imax_zerobased(0,Z_,0); subplot(prows,pcols,np); plot(x_,Z_,'k.-',x_(1+Z_index),Z,'ro',x_,zeros(n_x,1),'k:'); xlim([0,2*pi]); np=np+1; disp(sprintf(" %% Z %0.16f Z_index %d",Z,Z_index));
Z_ = exp(0.00-x_)+0.5*cos(3*x_); [Z,Z_index] = Z_imax_zerobased(0,Z_,0); subplot(prows,pcols,np); plot(x_,Z_,'k.-',x_(1+Z_index),Z,'ro',x_,zeros(n_x,1),'k:'); xlim([0,2*pi]); np=np+1; disp(sprintf(" %% Z %0.16f Z_index %d",Z,Z_index));
Z_ = exp(x_-2*pi)+0.5*cos(3*x_); [Z,Z_index] = Z_imax_zerobased(0,Z_,0); subplot(prows,pcols,np); plot(x_,Z_,'k.-',x_(1+Z_index),Z,'ro',x_,zeros(n_x,1),'k:'); xlim([0,2*pi]); np=np+1; disp(sprintf(" %% Z %0.16f Z_index %d",Z,Z_index));
Z_ = exp(0.00-x_)+0.5*sin(3*x_); [Z,Z_index] = Z_imax_zerobased(0,Z_,0); subplot(prows,pcols,np); plot(x_,Z_,'k.-',x_(1+Z_index),Z,'ro',x_,zeros(n_x,1),'k:'); xlim([0,2*pi]); np=np+1; disp(sprintf(" %% Z %0.16f Z_index %d",Z,Z_index));
Z_ = exp(x_-2*pi)+0.5*sin(3*x_); [Z,Z_index] = Z_imax_zerobased(0,Z_,0); subplot(prows,pcols,np); plot(x_,Z_,'k.-',x_(1+Z_index),Z,'ro',x_,zeros(n_x,1),'k:'); xlim([0,2*pi]); np=np+1; disp(sprintf(" %% Z %0.16f Z_index %d",Z,Z_index));
figbig;
sgtitle('Z_imax_zerobased');
disp('returning'); return;
end;%if nargin<1;

if (verbose);
disp(sprintf(' %% [entering Z_imax_zerobased]'));
if (verbose>1); disp(sprintf(' %% Z_min: %0.16f; Z_: ',Z_min)); disp(num2str(transpose(Z_(:)))); end;
end;%if (verbose);
n_Z = numel(Z_);
[Z_gmax,tmp_index] = max(Z_); tmp_index=tmp_index-1; zone_max = Z_gmax; zone_max_index = tmp_index;
if (Z_gmax<Z_min); zone_max = Z_gmax; zone_max_index = []; end;
if (Z_gmax>=Z_min);
index_sub_ = efind(Z_>=Z_min);
n_index_sub = length(index_sub_);
n_zone = 1;
for nindex_sub=0:n_index_sub-1-1;
if (index_sub_(1+nindex_sub+1)-index_sub_(1+nindex_sub+0))>1; n_zone = n_zone+1; end;
end;%for nindex_sub=0:n_index_sub-1-1;
if (verbose); disp(sprintf(' %% found %d zones',n_zone)); end;
nzone_start_ = zeros(1+n_zone,1); nzone_start_(1+0) = index_sub_(1+0);
nzone_final_ = zeros(1+n_zone,1); nzone_final_(1+n_zone-1) = index_sub_(1+n_index_sub-1);
nzone = 0;
for nindex_sub=0:n_index_sub-1-1;
if (index_sub_(1+nindex_sub+1)-index_sub_(1+nindex_sub))>1; 
nzone_final_(1+nzone+0) = index_sub_(1+nindex_sub+0); 
nzone_start_(1+nzone+1) = index_sub_(1+nindex_sub+1); 
nzone = nzone+1; 
end;%if (index_sub_(1+nindex_sub+1)-index_sub_(1+nindex_sub))>1; 
end;%for nindex_sub=0:n_index_sub-1-1;
if (verbose); 
for nzone=0:n_zone-1;
disp(sprintf(' %% zone %d: [%d:%d]',nzone,nzone_start_(1+nzone),nzone_final_(1+nzone)));
end;%for nzone=0:n_zone-1;
end;%if (verbose); 
zone_index__ = cell(n_zone,1);
n_zone_index_ = zeros(n_zone,1);
for nzone=0:n_zone-1;
zone_index__{1+nzone} = [nzone_start_(1+nzone):nzone_final_(1+nzone)];
n_zone_index_(1+nzone) = numel(zone_index__{1+nzone});
end;%for nzone=0:n_zone-1;
zone_max_ = zeros(n_zone,1);
zone_max_index_ = zeros(n_zone,1);
zone_valid_ = zeros(n_zone,1);
for nzone=0:n_zone-1;
[zone_max_(1+nzone),tmp_index] = max(Z_(1+zone_index__{1+nzone})); tmp_index = tmp_index-1;
zone_max_index_(1+nzone) = zone_index__{1+nzone}(1+tmp_index);
if (nzone>0 & nzone<n_zone-1); zone_valid_(1+nzone) = 1; end;
if (nzone==0 & zone_max_index_(1+nzone)>0 & zone_max_index_(1+nzone)<n_Z-1); zone_valid_(1+nzone) = 1; end;
if (nzone==n_zone-1 & zone_max_index_(1+nzone)>0 & zone_max_index_(1+nzone)<n_Z-1); zone_valid_(1+nzone) = 1; end;
end;%for nzone=0:n_zone-1;
if (verbose); 
for nzone=0:n_zone-1;
disp(sprintf(' %% zone %d: [%d:%d], max %0.2f, index %d, valid %d',nzone,nzone_start_(1+nzone),nzone_final_(1+nzone),zone_max_(1+nzone),zone_max_index_(1+nzone),zone_valid_(1+nzone)));
end;%for nzone=0:n_zone-1;
end;%if (verbose); 
if (sum(zone_valid_));
if (verbose); disp(sprintf(' %% found %d valid zones',sum(zone_valid_))); end;
zone_valid_index_ = efind(zone_valid_);
[zone_max,z_index] = max(zone_max_(1+zone_valid_index_)); z_index = z_index-1;
z_index = zone_valid_index_(1+z_index);
if (verbose); disp(sprintf(' %% found max in zone z_index: %d',z_index)); end;
assert(zone_max==zone_max_(1+z_index));
zone_max_index = zone_max_index_(1+z_index);
end;%if (sum(zone_valid_));
if (sum(zone_valid_)==0);
if (verbose); disp(sprintf(' %% found no valid zones')); end;
[zone_max,z_index] = max(zone_max_); z_index=z_index-1;
assert(zone_max==zone_max_(1+z_index));
zone_max_index = zone_max_index_(1+z_index);
if (verbose); disp(sprintf(' %% found max in zone z_index: %d',zone_max_index)); end;
if (0);
elseif ((zone_max_index==0 | zone_max_index==n_Z-1) & n_zone==1 & n_zone_index_(1+0)==n_Z);
tmp_min = min(Z_) + max(1e-12,abs(min(Z_))*1e-12);
if (verbose); disp(sprintf(' %% only one big zone; rerunning with new minimum Z_min %0.16f --> %0.16f',min(Z_),tmp_min)); end;
[zone_max,zone_max_index] = Z_imax_zerobased(verbose,Z_,tmp_min);
elseif (zone_max_index==0 & n_zone_index_(1+z_index)<n_Z);
if (verbose); disp(sprintf(' %% zone on left side')); end;
zone_lmax_index_ = localmax_zerobased(Z_(1+zone_index__{1+z_index})); zone_lmax_index_ = zone_index__{1+z_index}(1+zone_lmax_index_);
if numel(zone_lmax_index_)>1; 
if (verbose); disp(sprintf(' %% found local maximum')); end;
zone_max_index = zone_lmax_index_(2); zone_max = Z_(1+zone_max_index);
end;%if numel(zone_lmax_index_)>1; 
if numel(zone_lmax_index_)<=1; 
if (verbose); disp(sprintf(' %% could not find local maximum, choosing midpoint.')); end;
tmp_z = 0.5*(max(Z_(1+zone_index__{1+z_index})) + min(Z_(1+zone_index__{1+z_index})));
[~,zone_max_index] = min(abs(Z_(1+zone_index__{1+z_index})-tmp_z)); zone_max_index = zone_max_index-1;
zone_max_index = zone_index__{1+z_index}(1+zone_max_index);
zone_max = Z_(1+zone_max_index);
end;%if numel(zone_lmax_index_)<=1; 
elseif (zone_max_index==n_Z-1 & n_zone_index_(1+z_index)<n_Z);
if (verbose); disp(sprintf(' %% zone on right side')); end;
zone_lmax_index_ = localmax_zerobased(Z_(1+zone_index__{1+z_index})); zone_lmax_index_ = zone_index__{1+z_index}(1+zone_lmax_index_);
if numel(zone_lmax_index_)>1; 
if (verbose); disp(sprintf(' %% found local maximum')); end;
zone_max_index = zone_lmax_index_(2); zone_max = Z_(1+zone_max_index);
end;%if numel(zone_lmax_index_)>1; 
if numel(zone_lmax_index_)<=1; 
if (verbose); disp(sprintf(' %% could not find local maximum, choosing midpoint.')); end;
tmp_z = 0.5*(max(Z_(1+zone_index__{1+z_index})) + min(Z_(1+zone_index__{1+z_index})));
[~,zone_max_index] = min(abs(Z_(1+zone_index__{1+z_index})-tmp_z)); zone_max_index = zone_max_index-1;
zone_max_index = zone_index__{1+z_index}(1+zone_max_index);
zone_max = Z_(1+zone_max_index);
disp(sprintf(' %f %d',zone_max,zone_max_index));
end;%if numel(zone_lmax_index_)<=1; 
end;%if (0);
end;%if (sum(zone_valid_)==0);
if (verbose); disp(sprintf(' %% zone_max %0.2f<--%0.2f zone_max_index %d',zone_max,Z_(1+zone_max_index),zone_max_index)); end;
end;%if (Z_max>=Z_min);
if (verbose);disp(sprintf(' %% [finished Z_imax_zerobased]')); end;

setup_OptiPlex; dir_trunk = '/home/rangan/dir_bcc/dir_dolphin';
%setup_access1; dir_trunk = '/data/rangan/dir_bcc/dir_dolphin';
dir_jpg = sprintf('%s/dir_jpg',dir_trunk);
dir_mat = sprintf('%s/dir_mat',dir_trunk);

flag_replot=0;
flag_recalc=0;

flag_drift0=1;
flag_a_is_0=0;
flag_center=1;
dXX = 0;

fname_infix = sprintf('aid%.2dd%dc%d',dXX,flag_drift0,flag_center);

fname_data = sprintf('%s/Dolphin_Data_201918755_s2.xlsx',dir_trunk);
T_ = readtable(fname_data);
aid_ori_ = T_{:,1};
age_ori_ = T_{:,4};
nvar_base = 7;
dat_ori__ = T_{:,(1+nvar_base):end};
n_smp_ori = size(dat_ori__,1);
n_var_ori = size(dat_ori__,2);
string_dat_ori_name_ = cell(n_var_ori,1);
for nvar=0:n_var_ori-1;
string_dat_ori_name_{1+nvar} = T_.Properties.VariableNames{1+nvar_base+nvar};
end;%for nvar=0:n_var_ori-1;

nvar = efind(strcmp(string_dat_ori_name_,'SED60'));
dat_ori__(:,1+nvar) = log(1+dat_ori__(:,1+nvar));
string_dat_ori_name_{1+nvar} = sprintf('log(1+%s)',string_dat_ori_name_{1+nvar});
nvar = efind(strcmp(string_dat_ori_name_,'GGT'));
dat_ori__(:,1+nvar) = log(1+dat_ori__(:,1+nvar));
string_dat_ori_name_{1+nvar} = sprintf('log(1+%s)',string_dat_ori_name_{1+nvar});

dat_ret__ = dat_ori__;
mss_var_threshold = 500;
index_var_rmv_ = efind(sum(~isfinite(dat_ret__),1)>mss_var_threshold);
index_var_rmv_ = union(index_var_rmv_,efind(strcmp(string_dat_ori_name_,'RBCDist')));
index_var_rmv_ = union(index_var_rmv_,efind(strcmp(string_dat_ori_name_,'Albumin')));
index_var_ret_ = setdiff(0:n_var_ori-1,index_var_rmv_);
dat_ret__ = dat_ret__(:,1+index_var_ret_);
n_var_ret = size(dat_ret__,2);
string_dat_ret_name_ = cell(n_var_ret,1);
for nvar=0:n_var_ret-1;
string_dat_ret_name_{1+nvar} = string_dat_ori_name_{1+index_var_ret_(1+nvar)};
end;%for nvar=0:n_var_ret-1;

mss_smp_threshold = 7;
index_smp_ret_ = setdiff(0:n_smp_ori-1,efind(sum(~isfinite(dat_ret__),2)>mss_smp_threshold));
dat_ret__ = dat_ret__(1+index_smp_ret_,:);
n_smp_ret = size(dat_ret__,1);

aid_ret_ = aid_ori_(1+index_smp_ret_);
age_ret_ = age_ori_(1+index_smp_ret_);

aid_ = aid_ret_;
age_ = age_ret_;
dat_nrm__ = dat_ret__;
[n_smp,n_var] = size(dat_nrm__);
string_dat_name_ = string_dat_ret_name_;
prctile_threshold = 0.01;
for nvar=0:n_var-1;
tmp_index_ = efind(isfinite(dat_nrm__(:,1+nvar)));
tmp_lo = prctile(dat_nrm__(1+tmp_index_,1+nvar),100*prctile_threshold);
tmp_hi = prctile(dat_nrm__(1+tmp_index_,1+nvar),100*(1-prctile_threshold));
dat_nrm__(1+tmp_index_,1+nvar) = max(tmp_lo,min(tmp_hi,dat_nrm__(1+tmp_index_,1+nvar)));
end;%for nvar=0:n_var-1;

[a_drift_,b_drift_] = dolphin_estimate_ab_0(aid_,age_,dat_nrm__);

n_step = 1; dt_all_ = dolphin_dt_all_0(aid_,age_,n_step);

u_aid_ = unique(aid_);
n_aid = numel(u_aid_);
n_aid_ = zeros(n_aid,1);
index_aid__ = cell(n_aid,1);
for naid=0:n_aid-1;
tmp_index_aid_ = efind(aid_==u_aid_(1+naid));
index_aid__{1+naid} = tmp_index_aid_;
n_aid_(1+naid) = numel(index_aid__{1+naid});
tmp_dat_nrm__ = dat_nrm__(1+tmp_index_aid_,:);
tmp_age_ = age_(1+tmp_index_aid_);
if (flag_drift0==1); tmp_dat_nrm__ = tmp_dat_nrm__ - (ones(numel(tmp_age_),1)*reshape(b_drift_,[1,n_var]) + tmp_age_*reshape(a_drift_,[1,n_var])); end;
if (flag_drift0==0); tmp_dat_nrm__ = tmp_dat_nrm__; end;
if (flag_drift0==0 & flag_center==1); tmp_dat_nrm__ = normalize(tmp_dat_nrm__,'zscore'); end;
if (flag_drift0==0 & flag_center==0); tmp_dat_nrm__ = tmp_dat_nrm__; end;
dat_nrm__(1+tmp_index_aid_,:) = tmp_dat_nrm__;
end;%for naid=0:n_aid-1;
if (flag_drift0==1 & flag_center==1); dat_nrm__ = normalize(dat_nrm__,'zscore'); end;
if (flag_drift0==1 & flag_center==0); dat_nrm__ = dat_nrm__; end;

%{

  n_step = 1;
  dt_all_ = [];
  for naid=0:n_aid-1;
  tmp_index_aid_ = index_aid__{1+naid};
  tmp_age_ = age_(1+tmp_index_aid_);
  [tmp_age_sort_,tmp_index_] = sort(tmp_age_,'ascend'); tmp_index_ = tmp_index_-1;
  for nstep=0;n_step-1;
  dt_ = tmp_age_sort_(1+(1+nstep):end)-tmp_age_sort_(1:end-(1+nstep));
  dt_all_ = [dt_all_;dt_];
  end;%for nstep=0;n_step-1;
  end;%for naid=0:n_aid-1;
  %%%%%%%%;
  % RBCDist and Albumin look strange. ;
  %%%%%%%%;
  figure(1);clf;
  c_ = {'r','k'};
  nvar = efind(strcmp(string_dat_ori_name_,'RBCDist'));
  subplot(2,1,1); cla;
  hold on;
  age_base=0;
  for naid=0:n_aid-1;
  tmp_index_aid_ = index_aid__{1+naid};
  tmp_age_ = age_(1+tmp_index_aid_);
  [tmp_age_,tmp_index_] = sort(tmp_age_,'ascend'); tmp_index_ = tmp_index_-1;
  tmp_var_ = dat_ori__(1+tmp_index_aid_,1+nvar); tmp_var_ = tmp_var_(1+tmp_index_);
  plot(age_base+tmp_age_,tmp_var_,'.','Color',c_{1+mod(naid,2)});
  age_base = age_base + max(tmp_age_) + 1;
  end;%for naid=0:n_aid-1;
  hold off;
  title(string_dat_ori_name_{1+nvar});
  %%%%%%%%;
  nvar = efind(strcmp(string_dat_ori_name_,'Albumin'));
  subplot(2,1,2); cla;
  hold on;
  age_base=0;
  for naid=0:n_aid-1;
  tmp_index_aid_ = index_aid__{1+naid};
  tmp_age_ = age_(1+tmp_index_aid_);
  [tmp_age_,tmp_index_] = sort(tmp_age_,'ascend'); tmp_index_ = tmp_index_-1;
  tmp_var_ = dat_ori__(1+tmp_index_aid_,1+nvar); tmp_var_ = tmp_var_(1+tmp_index_);
  plot(age_base+tmp_age_,tmp_var_,'.','Color',c_{1+mod(naid,2)});
  age_base = age_base + max(tmp_age_) + 1;
  end;%for naid=0:n_aid-1;
  hold off;
  title(string_dat_ori_name_{1+nvar});
  %%%%%%%%;
  figbig;
  print('-depsc',sprintf('%s/dolphin_ori_RBCDist_Albumin_0.eps',dir_jpg));
  print('-djpeg',sprintf('%s/dolphin_ori_RBCDist_Albumin_0.jpg',dir_jpg));
  pause(2);close(gcf);

  %%%%%%%%;
  % looks like we should log-normalize SED60 and GGT. ;
  %%%%%%%%;
  figure(1);clf;
  nvar = efind(strcmp(string_dat_ori_name_,'NRBC'));
  subplot(2,3,1); hist(dat_ori__(:,1+nvar),32); title(string_dat_ori_name_{1+nvar});
  subplot(2,3,4); hist(log(1+dat_ori__(:,1+nvar)),32); title(sprintf('log(%s)',string_dat_ori_name_{1+nvar}));
  nvar = efind(strcmp(string_dat_ori_name_,'log(1+SED60)'));
  subplot(2,3,2); hist(dat_ori__(:,1+nvar),32); title(string_dat_ori_name_{1+nvar});
  subplot(2,3,5); hist(exp(dat_ori__(:,1+nvar))-1,32); title(sprintf('exp(%s)-1',string_dat_ori_name_{1+nvar}));
  nvar = efind(strcmp(string_dat_ori_name_,'log(1+GGT)'));
  subplot(2,3,3); hist(dat_ori__(:,1+nvar),32); title(string_dat_ori_name_{1+nvar});
  subplot(2,3,6); hist(exp(dat_ori__(:,1+nvar))-1,32); title(sprintf('exp(%s)-1',string_dat_ori_name_{1+nvar}));
  print('-depsc',sprintf('%s/dolphin_ori_hist_NRBC_SED60_GGT_0.eps',dir_jpg));
  print('-djpeg',sprintf('%s/dolphin_ori_hist_NRBC_SED60_GGT_0.jpg',dir_jpg));
  pause(2);close(gcf);

  %}

n_step = 1; relative_variation = dolphin_relative_variation_0(aid_,age_,dat_nrm__,n_step);

%%%%%%%%;
% Now load nivedita causality data. ;
%%%%%%%%;
fname_data = sprintf('%s/causality_result_summary_20201123.csv',dir_trunk);
T2_ = readtable(fname_data);
%%%%%%%%;
% now form a matrix from T2_ selecting the variables listed in string_dat_name_. ;
%%%%%%%%;
index_0_var_in_niv__ = cell(n_var,1);
index_1_var_in_niv__ = cell(n_var,1);
for nvar=0:n_var-1;
tmp_name = string_dat_name_{1+nvar};
if strcmp(tmp_name,'log(1+GGT)'); tmp_name = 'GGT'; end;
if strcmp(tmp_name,'log(1+SED60)'); tmp_name = 'SED60'; end;
index_0_var_in_niv__{1+nvar} = efind(strcmp(T2_{:,1+0},tmp_name));
index_1_var_in_niv__{1+nvar} = efind(strcmp(T2_{:,1+1},tmp_name));
end;%for nvar=0:n_var-1;
A_niv__ = zeros(n_var,n_var);
for nvar0=0:n_var-1;
for nvar1=0:n_var-1;
tmp_index = intersect(index_0_var_in_niv__{1+nvar0},index_1_var_in_niv__{1+nvar1});
%A_niv__(1+nvar0,1+nvar1) = sum(T2_{1+tmp_index,1+2}); %<-- no transpose. ;
A_niv__(1+nvar1,1+nvar0) = sum(T2_{1+tmp_index,1+2}); %<-- note transpose. ;
end;%for nvar1=0:n_var-1;
end;%for nvar0=0:n_var-1;

fname_mat = sprintf('%s/dolphin_dXX_collect_1.mat',dir_mat);
if ( exist(fname_mat,'file'));
collect_ = load(fname_mat);
disp(sprintf(' %% collect_.A_full_found_ %d/%d',numel(efind(collect_.A_full_found_)),collect_.n_dXX));
disp(sprintf(' %% collect_.A_pair_found_ %d/%d',numel(efind(collect_.A_pair_found_)),collect_.n_dXX));
disp(sprintf(' %% collect_.A_both_found_ %d/%d',numel(efind(collect_.A_full_found_ & collect_.A_pair_found_)),collect_.n_dXX));
collect_.A_both_found_ = collect_.A_full_found_ & collect_.A_pair_found_;
tmp_index_ = efind(collect_.A_both_found_);
collect_.A_full_Z___ = collect_.A_full_Z___(:,:,1+tmp_index_);
collect_.A_full_nlp___ = collect_.A_full_nlp___(:,:,1+tmp_index_);
collect_.A_pair_Z___ = collect_.A_pair_Z___(:,:,1+tmp_index_);
collect_.A_pair_nlp___ = collect_.A_pair_nlp___(:,:,1+tmp_index_);
collect_.dXX_ = collect_.dXX_(1+tmp_index_);
collect_.n_dXX = numel(collect_.dXX_);
end;%if ( exist(fname_mat,'file'));

B_niv__ = A_niv__/n_aid;
%B_pairX__ = median(collect_.A_pair_nlp___(:,:,2:end),3); for nvar=0:n_var-1; B_pairX__(1+nvar,1+nvar)=0; end;
B_pairX__ = mean(collect_.A_pair_nlp___(:,:,2:end)>3.0,3); for nvar=0:n_var-1; B_pairX__(1+nvar,1+nvar)=0; end;
B_pair0__ = collect_.A_pair_nlp___(:,:,1+0); for nvar=0:n_var-1; B_pair0__(1+nvar,1+nvar)=0; end;
B_full0__ = collect_.A_full_nlp___(:,:,1+0); for nvar=0:n_var-1; B_full0__(1+nvar,1+nvar)=0; end;
fname_fig = sprintf('%s/dir_jpg/dolphin_causality_1b',dir_trunk);
if (~exist(sprintf('%s.jpg',fname_fig),'file'));
disp(sprintf(' %% %s not found, creating',fname_fig));
figure(1);clf;
figbeach();
subplot(2,2,1);
imagesc(B_niv__,[0,.20]); axis image;
set(gca,'XTick',1:n_var,'XTickLabel',string_dat_name_); xtickangle(90);
set(gca,'YTick',1:n_var,'YTickLabel',string_dat_name_); 
xlabel('from'); ylabel('to');
title('niv');
subplot(2,2,2);
%imagesc(B_pairX__,[0,6]); axis image;
imagesc(B_pairX__,[0,.20]); axis image;
set(gca,'XTick',1:n_var,'XTickLabel',string_dat_name_); xtickangle(90);
set(gca,'YTick',1:n_var,'YTickLabel',string_dat_name_); 
xlabel('from'); ylabel('to');
title(sprintf('pairX c%0.3f',corr(B_pairX__(:),B_niv__(:))));
subplot(2,2,3);
imagesc(B_pair0__,[0,6]); axis image;
set(gca,'XTick',1:n_var,'XTickLabel',string_dat_name_); xtickangle(90);
set(gca,'YTick',1:n_var,'YTickLabel',string_dat_name_); 
xlabel('from'); ylabel('to');
title(sprintf('pair0 c%0.3f',corr(B_pair0__(:),B_niv__(:))));
subplot(2,2,4);
imagesc(B_full0__,[0,6]); axis image;
set(gca,'XTick',1:n_var,'XTickLabel',string_dat_name_); xtickangle(90);
set(gca,'YTick',1:n_var,'YTickLabel',string_dat_name_); 
xlabel('from'); ylabel('to');
title(sprintf('full0 c%0.3f',corr(B_full0__(:),B_niv__(:))));
figbig;
disp(sprintf(' %% writing %s',fname_fig));
print('-djpeg',sprintf('%s.jpg',fname_fig));
print('-depsc',sprintf('%s.eps',fname_fig));
close(gcf);
end;%if (~exist(sprintf('%s.jpg',fname_fig),'file'));
if ( exist(sprintf('%s.jpg',fname_fig),'file'));
disp(sprintf(' %% %s found, not creating',fname_fig));
end;%if ( exist(sprintf('%s.jpg',fname_fig),'file'));

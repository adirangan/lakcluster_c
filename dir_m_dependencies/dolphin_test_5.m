function [tru_,est_,null_] = dolphin_test_5(rseed,n_var,dt_avg,n_T_0in,relative_variation,snr);
% Generates data with drift, but tests_dolphin_estimate_ABC_0 after approximating and removing drift. ;
% Assumes exponential distribution of dt with mean dt_avg. ;
% Simulates SDE recovery, alongside irg granger_test. ;
%{
%try: ;

dXX = 0;
n_var = 2; %<-- pair. ;
dt_avg = 0.257; %<-- matches d00 data. ;
relative_variation = 0.8973; %<-- matches d00 data. ;
for n_T_0in = [128,256,512,1024]; %<-- matches d01 data. ;%n_T_0in = 5664; %<-- matches d00 data. ;
snr_ = 2.^[-3:+0.5:+3]; n_snr = numel(snr_);
rseed_ = 0:16; n_rseed = numel(rseed_);
for nrseed=0:n_rseed-1;
rseed = rseed_(1+nrseed);
for nsnr=0:n_snr-1;
snr = snr_(1+nsnr);
[tru_,est_,null_] = dolphin_test_5(rseed,n_var,dt_avg,n_T_0in,relative_variation,snr);
end;%for nsnr=0:n_snr-1;
end;%for nrseed=0:n_rseed-1;
end;%for n_T_0in = [128,256,512,1024];

%}

date_diff_threshold = 0.5;
flag_verbose = 0;

%setup_OptiPlex;
setup_access1;

dir_trunk = '/data/rangan/dir_bcc/dir_dolphin';
dir_R = sprintf('%s/dir_R',dir_trunk);
dir_irg_csv = sprintf('%s/dir_irg_csv',dir_R);
dir_irg_mat = sprintf('%s/dir_irg_mat',dir_R);
dir_jpg = sprintf('%s/dir_jpg',dir_trunk);

flag_replot=1;
flag_a_is_0=0;

string_infix = dolphin_test_5_infix(rseed,n_var,dt_avg,n_T_0in,relative_variation,snr);
fname_dat_mat = sprintf('%s/%s_dat__.mat',dir_irg_mat,string_infix);
fname_age_csv = sprintf('%s/%s_age_.csv',dir_irg_csv,string_infix);
fname_dat_csv = sprintf('%s/%s_dat__.csv',dir_irg_csv,string_infix);
fname_out_mat = sprintf('%s/%s_out.mat',dir_irg_mat,string_infix);
fname_irg_R = sprintf('%s/%s_irg.R',dir_R,string_infix);
fname_irg_out = sprintf('%s/%s_irg_out__.csv',dir_irg_csv,string_infix);

flag_skip = 0;
if ( exist(fname_irg_out,'file')); flag_skip = 1; end;
if (~exist(fname_irg_out,'file'));
flag_skip=0;
fname_irg_tmp = sprintf('%s/%s_irg_out__.tmp',dir_irg_csv,string_infix);
if ( exist(fname_irg_tmp,'file'));
tmp_date_diff = datenum(clock) - datenum(dir(fname_irg_tmp).date);
if (tmp_date_diff< date_diff_threshold);
disp(sprintf(' %% %s found, tmp_date_diff = %0.2f = recent, skipping',fname_irg_tmp,tmp_date_diff));
flag_skip=1;
end;%if (tmp_date_diff< date_diff_threshold);
if (tmp_date_diff>=date_diff_threshold);
disp(sprintf(' %% %s found, tmp_date_diff = %0.2f = stale, deleting',fname_irg_tmp,tmp_date_diff));
delete(fname_irg_tmp);
flag_skip=0;
end;%if (tmp_date_diff>=date_diff_threshold);
end;%if ( exist(fname_irg_tmp,'file'));
end;%if (~exist(fname_irg_out,'file'));

if (~flag_skip);
disp(sprintf(' %% %s not found, creating',fname_irg_out));
save(fname_irg_tmp,'fname_irg_tmp');

%%%%%%%%;
% Generate data. ;
%%%%%%%%;
rng(rseed);
%%%%%%%%;
if ( exist(fname_dat_mat,'file')); disp(sprintf(' %% %s found, not creating',fname_dat_mat)); end;
if (~exist(fname_dat_mat,'file'));
disp(sprintf(' %% %s not found, creating',fname_dat_mat));
%%%%%%%%;
a_tru_ = 1.0*randn(n_var,1);
A_tru__ = randn(n_var,n_var);
[Psi__,Lambda__] = eig(A_tru__); Psi_inv__ = inv(Psi__);
Lambda_ = diag(Lambda__);
for nvar=0:n_var-1; Lambda_(1+nvar) = min(-0.1,real(Lambda_(1+nvar))) + i*imag(Lambda_(1+nvar)); end; %<-- rectify spectrum of A. ;
Lambda__ = diag(Lambda_);
A_tru__ = real(Psi__*Lambda__*Psi_inv__);
C_tru__  = 1.0*randn(n_var,n_var); CC_tru__ = transpose(C_tru__)*C_tru__;
B_tru__  = 1.0*randn(n_var,n_var); BB_tru__ = transpose(B_tru__)*B_tru__;
A_inv_a_ = inv(A_tru__)*a_tru_;
tmp_n_T = 1024*1;
R_diff = @(log_amplitude) evolve_SDE(rseed,tmp_n_T,n_var,dt_avg,A_inv_a_,Psi__,Lambda_,Psi_inv__,B_tru__,C_tru__,snr,log_amplitude) - relative_variation ;
log_amplitude = fzero(R_diff,1.0);
R_est = evolve_SDE(rseed,tmp_n_T,n_var,dt_avg,A_inv_a_,Psi__,Lambda_,Psi_inv__,B_tru__,C_tru__,snr,log_amplitude);
if (flag_verbose); disp(sprintf(' %% estimated log_amplitude %0.4f --> amplitude %0.4f --> R_est %0.4f',log_amplitude,exp(log_amplitude),R_est)); end;
%%%%%%%%;
[R_avg,dt_,age_,Y__] = evolve_SDE(rseed,n_T_0in,n_var,dt_avg,A_inv_a_,Psi__,Lambda_,Psi_inv__,B_tru__,C_tru__,snr,log_amplitude);
amplitude = exp(log_amplitude);
%%%%%%%%;
aid_ = ones(n_T_0in,1);
dat__ = transpose(Y__);
if (flag_verbose); plot(Y__(1,:),Y__(2,:),'.-'); end;
[n_smp,n_var] = size(dat__);
string_dat_name_ = {'x';'y'};
dt_all_ = diff(age_);
n_step = 1;
dt_lim_ = [0;max(age_(1+n_step:end)-age_(1:end-n_step))];
%%%%%%%%;
save(fname_dat_mat ...
     , 'rseed', 'n_var', 'dt_avg', 'n_T_0in', 'relative_variation', 'snr' ...
     , 'a_tru_', 'A_tru__', 'C_tru__', 'CC_tru__', 'B_tru__', 'BB_tru__' ...
     , 'A_inv_a_', 'R_diff', 'log_amplitude', 'R_est', 'R_avg', 'dt_', 'age_', 'aid_', 'dat__' ...
     );
writematrix(age_,fname_age_csv);
writematrix(dat__,fname_dat_csv);
%%%%%%%%;
end;%if (~exist(fname_dat_mat,'file'));
load(fname_dat_mat);

if ( exist(fname_out_mat,'file')); disp(sprintf(' %% %s found, not creating',fname_out_mat)); end;
if (~exist(fname_out_mat,'file'));
disp(sprintf(' %% %s not found, creating',fname_out_mat));

%%%%%%%%;
% Now estimate drift. ;
%%%%%%%%;
dat_nrm__ = dat__;
[a_drift_,b_drift_] = dolphin_estimate_ab_0(aid_,age_,dat_nrm__);
a_est_ = a_drift_;
b_est_ = b_drift_;
amplitude = exp(log_amplitude);
corr_a = corr(a_est_(:),amplitude*a_tru_(:));
dat_nrm__ = dat_nrm__ - (ones(numel(age_),1)*reshape(b_drift_,[1,n_var]) + age_*reshape(a_drift_,[1,n_var]));
%%%%%%%%;
% then estimate SDE. ;
%%%%%%%%;
n_step = 1; n_iteration = 4;
[A_est__,BB_est__,CC_est__,L_est_,niteration_est,A_est___,BB_est___,CC_est___] = dolphin_estimate_ABC_0(aid_,age_,dat_nrm__,n_step,n_iteration);
if (flag_verbose>1); disp(sprintf(' %% L_est_: ')); disp(L_est_); end;
[~,tmp_index_min] = min(L_est_(1:1+niteration_est)); tmp_index_min = tmp_index_min - 1;
A_est__ = A_est___{1+tmp_index_min};
BB_est__ = BB_est___{1+tmp_index_min};
CC_est__ = CC_est___{1+tmp_index_min};
L_est = L_est_(1+tmp_index_min);
corr_A = corr(A_est__(:),amplitude*A_tru__(:));
corr_BB = corr(BB_est__(:),(amplitude/snr)^2*BB_tru__(:));
corr_CC = corr(CC_est__(:),(amplitude/snr)^2*CC_tru__(:));
%%%%%%%%;
% Now repeat for shuffled permutations. ;
% For these shuffled permutation we retain the same drift and normalized data. ;
%%%%%%%%;
n_shuffle = 32;
A_null___ = cell(n_shuffle,1);
BB_null___ = cell(n_shuffle,1);
CC_null___ = cell(n_shuffle,1);
for nshuffle=0:n_shuffle-1;
dat_nrm_prm__ = dolphin_permute_0(aid_,age_,dat_nrm__,nshuffle);
[A_prm__,BB_prm__,CC_prm__,L_prm_,niteration_prm,A_prm___,BB_prm___,CC_prm___] = dolphin_estimate_ABC_0(aid_,age_,dat_nrm_prm__,n_step,n_iteration);
[~,tmp_index_min] = min(L_prm_(1:1+niteration_prm)); tmp_index_min = tmp_index_min-1;
A_null___{1+nshuffle} = A_prm___{1+tmp_index_min};
BB_null___{1+nshuffle} = BB_prm___{1+tmp_index_min};
CC_null___{1+nshuffle} = CC_prm___{1+tmp_index_min};
L_null_{1+nshuffle} = L_prm_(1+tmp_index_min);
end;%for nshuffle=0:n_shuffle-1;
%%%%%%%%;

%%%%%%%%;
% collect null distribution. ;
%%%%%%%%;
A_null_avg__ = zeros(n_var,n_var);
BB_null_avg__ = zeros(n_var,n_var);
CC_null_avg__ = zeros(n_var,n_var);
L_null_avg = 0;
A_null_std__ = zeros(n_var,n_var);
BB_null_std__ = zeros(n_var,n_var);
CC_null_std__ = zeros(n_var,n_var);
L_null_std = 0;
%%%%%%%%;
for nshuffle=0:n_shuffle-1;
A_null_avg__ = A_null_avg__ + A_null___{1+nshuffle};
BB_null_avg__ = BB_null_avg__ + BB_null___{1+nshuffle};
CC_null_avg__ = CC_null_avg__ + CC_null___{1+nshuffle};
L_null_avg = L_null_avg + L_null_{1+nshuffle};
A_null_std__ = A_null_std__ + A_null___{1+nshuffle}.^2;
BB_null_std__ = BB_null_std__ + BB_null___{1+nshuffle}.^2;
CC_null_std__ = CC_null_std__ + CC_null___{1+nshuffle}.^2;
L_null_std = L_null_std + L_null_{1+nshuffle}.^2;
end;%for nshuffle=0:n_shuffle-1;
%%%%%%%%;
A_null_avg__ = A_null_avg__ / n_shuffle;
BB_null_avg__ = BB_null_avg__ / n_shuffle;
CC_null_avg__ = CC_null_avg__ / n_shuffle;
L_null_avg = L_null_avg / n_shuffle;
A_null_std__ = sqrt(A_null_std__/n_shuffle - A_null_avg__.^2);
BB_null_std__ = sqrt(BB_null_std__/n_shuffle - BB_null_avg__.^2);
CC_null_std__ = sqrt(CC_null_std__/n_shuffle - CC_null_avg__.^2);
L_null_std = sqrt(L_null_std/n_shuffle - L_null_avg.^2);
%%%%%%%%;
A_Z__ = real((A_est__ - A_null_avg__)./A_null_std__);
BB_Z__ = real((BB_est__ - BB_null_avg__)./BB_null_std__);
CC_Z__ = real((CC_est__ - CC_null_avg__)./CC_null_std__);
L_Z = real((L_est - L_null_avg)./L_null_std);
A_nlp__ = -z_to_p_twosided_0(A_Z__);
BB_nlp__ = -z_to_p_twosided_0(BB_Z__);
CC_nlp__ = -z_to_p_twosided_0(CC_Z__);
L_nlp = -z_to_p_twosided_0(L_Z);

tru_ = struct('type','tru');
tru_.a_tru_ = a_tru_;
tru_.A_tru__ = A_tru__;
tru_.BB_tru__ = BB_tru__;
tru_.CC_tru__ = CC_tru__;

est_ = struct('type','est');
est_.n_step = n_step;
est_.n_iteration = n_iteration;
est_.niteration_est = niteration_est;
est_.a_est_ = a_est_;
est_.b_est_ = b_est_;
est_.A_est__ = A_est__;
est_.BB_est__ = BB_est__;
est_.CC_est__ = CC_est__;
est_.L_est = L_est;
est_.corr_a = corr_a;
est_.corr_A = corr_A;
est_.corr_BB = corr_BB;
est_.corr_CC_= corr_CC;

null_ = struct('type','null');
null_.n_shuffle = n_shuffle;
null_.A_null___ = A_null___;
null_.BB_null___ = BB_null___;
null_.CC_null___ = CC_null___;
null_.L_null_ = L_null_;
null_.A_null_avg__ = A_null_avg__;
null_.BB_null_avg__ = BB_null_avg__;
null_.CC_null_avg__ = CC_null_avg__;
null_.L_null_avg = L_null_avg;
null_.A_null_std__ = A_null_std__;
null_.BB_null_std__ = BB_null_std__;
null_.CC_null_std__ = CC_null_std__;
null_.L_null_std = L_null_std;
null_.A_Z__ = A_Z__;
null_.BB_Z__ = BB_Z__;
null_.CC_Z__ = CC_Z__;
null_.L_Z = L_Z;
null_.A_nlp__ = A_nlp__;
null_.BB_nlp__ = BB_nlp__;
null_.CC_nlp__ = CC_nlp__;
null_.L_nlp = L_nlp;

save(fname_out_mat ...
     , 'tru_', 'est_', 'null_' ...
     );
%%%%%%%%;
end;%if (~exist(fname_out_mat,'file'));
load(fname_out_mat);

%%%%%%%%;
% Generate irg R file. ;
%%%%%%%%;
if ( exist(fname_irg_R,'file')); disp(sprintf(' %% %s found, not creating',fname_irg_R)); end;
if (~exist(fname_irg_R,'file')); disp(sprintf(' %% %s not found, creating',fname_irg_R));
%%%%%%%%;
fp = fopen(fname_irg_R,'w');
fprintf(fp,'# install.packages("remotes");\n');
fprintf(fp,'# remotes::install_github("SMAC-Group/irg");\n');
fprintf(fp,'setwd("%s");\n',dir_R);
fprintf(fp,'library(irg);\n');
fprintf(fp,'library(mgcv);\n');
fprintf(fp,'################;\n');
fprintf(fp,'# Average signals at matching time points and then standardize;\n');
fprintf(fp,'avg <- function(signals) {\n');
fprintf(fp,'  signal <- rep(NA, length(signals)/3)\n');
fprintf(fp,'  for(i in 1:(length(signals)/3)) {\n');
fprintf(fp,'    signal[i] <- mean(signals[(3*(i-1) + 1) : (3*i)])\n');
fprintf(fp,'  }\n');
fprintf(fp,'  signal_std <- (signal - mean(signal))/sd(signal)\n');
fprintf(fp,'  return(signal_std)\n');
fprintf(fp,'}\n');
fprintf(fp,'# Pre-processing function uses GAM to detrend the signals and then uses previous function to aggregate and normalize\n');
fprintf(fp,'pre_process_single <- function(dat_0_,age_) {\n');
fprintf(fp,'  mod_0 <- gam(dat_0_ ~ s(age_))\n');
fprintf(fp,'  resid_0 <- avg(resid(mod_0))\n');
fprintf(fp,'  return(resid_0)\n');
fprintf(fp,'}\n');
fprintf(fp,'################;\n');
fprintf(fp,'age_ <- read.table("%s",sep=",");\n',fname_age_csv);
fprintf(fp,'dat__ <- read.table("%s",sep=",");\n',fname_dat_csv);
fprintf(fp,'age_nrm_ <- rep(NA,length(age_[,1])/3);\n\n');
fprintf(fp,'for(i in 1:(length(age_[,1])/3)) {\n');
fprintf(fp,'  age_nrm_[i] <- mean(age_[(3*(i-1) + 1) : (3*i),1])\n');
fprintf(fp,'}#for(i in 1:(length(age_[,1])/3));\n');
fprintf(fp,'################;\n');
fprintf(fp,'n_smp <- dim(dat__)[1];\n');
fprintf(fp,'n_var <- dim(dat__)[2];\n');
fprintf(fp,'################;\n');
fprintf(fp,'for (nvar0 in 0:(n_var-1)){');
fprintf(fp,'if (nvar0<n_var-1){');
fprintf(fp,'for (nvar1 in (nvar0+1):(n_var-1)){');
fprintf(fp,'################;\n');
fprintf(fp,'string_out <- c(nvar0,nvar1);\n');
fprintf(fp,'write(string_out,"");\n');
fprintf(fp,'dat_0_ <- dat__[,1+nvar0];\n');
fprintf(fp,'dat_1_ <- dat__[,1+nvar1];\n');
fprintf(fp,'################;\n');
fprintf(fp,'dat_nrm_0_ <- pre_process_single(dat_0_,age_[,1]);\n');
fprintf(fp,'dat_nrm_1_ <- pre_process_single(dat_1_,age_[,1]);\n');
fprintf(fp,'################;\n');
fprintf(fp,'dat_nrm__ <- data.frame(dat_nrm_0_,dat_nrm_1_,age_nrm_);\n');
fprintf(fp,'result_nrm_ <- granger_test(dat_nrm__[,1],dat_nrm__[,2],dat_nrm__[,3],theta=NULL,alternative="twodir",H=100,seed=0,showprogress=TRUE);\n');
fprintf(fp,'output_nrm_ <- c(nvar0,nvar1,result_nrm_$pvalue,result_nrm_$parameters);\n');
fprintf(fp,'write(output_nrm_,"%s",append=TRUE);\n',fname_irg_out);
fprintf(fp,'################;\n');
fprintf(fp,'}#for (nvar1 in (nvar0+1):(n_var-1));\n');
fprintf(fp,'}#if (nvar0<n_var-1);\n');
fprintf(fp,'}#for (nvar0 in 0:(n_var-1));\n');
fclose(fp);
%%%%%%%%;
end;%if (~exist(fname_irg_R,'file'));

%%%%%%%%;
% Generate irg R file. ;
%%%%%%%%;
if ( exist(fname_irg_out,'file')); disp(sprintf(' %% %s found, not creating',fname_irg_out)); end;
if (~exist(fname_irg_out,'file')); disp(sprintf(' %% %s not found, creating',fname_irg_out));
string_command = sprintf(' Rscript %s;',fname_irg_R);
system(string_command);
end;%if (~exist(fname_irg_out,'file'));

delete(fname_irg_tmp);
end;%if (~flag_skip);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%;

function string_infix = dolphin_test_5_infix(rseed,n_var,dt_avg,n_T_0in,relative_variation,snr);
str_dt = sprintf('dt%.4d',floor(1000*dt_avg));
str_n_T = sprintf('T%.4d',floor(n_T_0in));
str_rv = sprintf('rv%.4d',floor(1000*relative_variation));
str_snr = sprintf('snr%.4d',floor(1000*snr));
string_infix = sprintf('dt5_rng%d_n%d_%s_%s_%s_%s',rseed,n_var,str_dt,str_n_T,str_rv,str_snr);

function [R_avg,dt_,age_,Y__] = evolve_SDE(rseed,n_T,n_var,dt_avg,A_inv_a_,Psi__,Lambda_,Psi_inv__,B__,C__,snr,log_amplitude);
flag_verbose=0;
if flag_verbose; disp(sprintf(' %% [entering evolve_SDE] log_amplitude %0.2f --> amplitude %0.2f',log_amplitude,exp(log_amplitude))); end;
rng(rseed);
Y__ = zeros(n_var,n_T);
Y__(:,1+0) = randn(n_var,1);
age_ = zeros(n_T,1);
dt_ = zeros(n_T-1,1);
R_ = zeros(n_T-1,1);
for nT=1:n_T-1;
dt=-dt_avg * log(1-rand());
dt_(1+nT-1) = dt;
age_(1+nT) = age_(1+nT-1) + dt;
Y_pre_ = Y__(:,1+nT-1);
tmp_exp_Adt__ = Psi__ * diag(exp(+exp(log_amplitude)*Lambda_*dt)) * Psi_inv__;
Y_pos_ = real( -A_inv_a_ + tmp_exp_Adt__ * (Y_pre_ + A_inv_a_ + SDE_sample_int_expAsBdW(dt,Psi__,exp(log_amplitude)*Lambda_,exp(log_amplitude)/snr*Psi_inv__*B__,1e-2)) );
Y__(:,1+nT+0) = Y_pos_ + exp(log_amplitude)/snr*C__*randn(n_var,1);
R_(1+nT-1) = fnorm(Y__(:,1+nT+0) - Y__(:,1+nT-1))/fnorm(Y__(:,1+nT-1));
end;%for nT=1:n_T-1;
R_avg = mean(R_);
if flag_verbose; disp(sprintf(' %% [finished evolve_SDE] R_avg %0.2f',R_avg)); end;

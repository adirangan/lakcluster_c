%%%%%%%%;
% step through each of the 44 variables. ;
%%%%%%%%;
clear;
dXX = 0;
age_percentile_range_ = [];
sex_constrain = [];
%%%%%%%%;
platform = 'access1';
if (exist('platform.type','file')); fp=fopen('platform.type'); platform = fscanf(fp,'%s'); fclose(fp); end;
if (strcmp(platform,'access1')); setup_access1; string_root = 'data'; end;
if (strcmp(platform,'eval1')); setup_eval1; string_root = 'home'; end;
if (strcmp(platform,'OptiPlex')); setup_OptiPlex; string_root = 'home'; end;
dir_trunk = sprintf('/%s/rangan/dir_bcc/dir_dolphin',string_root);
dir_jpg = sprintf('%s/dir_jpg',dir_trunk);
dir_mat = sprintf('%s/dir_mat',dir_trunk);
dir_shuffle_mat = sprintf('%s/dir_shuffle_mat',dir_trunk);
%%%%%%%%;
flag_replot=0;
flag_recalc=0;
%%%%%%%%;
fname_data = sprintf('%s/Dolphin_Data_201918755_s2.xlsx',dir_trunk);
T_ = readtable(fname_data);
%%%%%%%%;
aid_ori_ = T_{:,1};
u_aid_ori_ = unique(aid_ori_); n_u_aid_ori = numel(u_aid_ori_);
n_u_aid_ori_ = zeros(n_u_aid_ori,1);
index_aid_ori__ = cell(n_u_aid_ori,1);
for nu_aid_ori=0:n_u_aid_ori-1;
index_aid_ori_ = efind(aid_ori_==u_aid_ori_(1+nu_aid_ori));
n_u_aid_ori_(1+nu_aid_ori) = numel(index_aid_ori_);
index_aid_ori__{1+nu_aid_ori} = index_aid_ori_;
end;%for nu_aid_ori=0:n_u_aid_ori-1;
%%%%%%%%;
spe_ori_ = T_{:,3}; %<-- retain TT species. ;
u_spe_ori_ = unique(spe_ori_); n_u_spe_ori = numel(u_spe_ori_);
n_u_spe_ori_ = zeros(n_u_spe_ori,1);
index_spe_ori__ = cell(n_u_spe_ori,1);
for nu_spe_ori=0:n_u_spe_ori-1;
index_spe_ori_ = efind(strcmp(spe_ori_,u_spe_ori_{1+nu_spe_ori}));
n_u_spe_ori_(1+nu_spe_ori) = numel(index_spe_ori_);
index_spe_ori__{1+nu_spe_ori} = index_spe_ori_;
end;%for nu_spe_ori=0:n_u_spe_ori-1;
isTT_ori_ = cellfun(@(x)strcmp(x,'TT'),spe_ori_);
%%%%%%%%;
lab_ori_ = T_{:,7}; %<-- may need to ignore lab_code, as some dolphins have multiple lab_codes. ;
lab_let_ori_ = cast(lab_ori_ - min(lab_ori_) + 'A','char');
u_lab_ori_ = unique(lab_ori_); n_u_lab_ori = numel(u_lab_ori_);
n_u_lab_ori_ = zeros(n_u_lab_ori,1);
index_lab_ori__ = cell(n_u_lab_ori,1);
for nu_lab_ori=0:n_u_lab_ori-1;
index_lab_ori_ = efind(lab_ori_==u_lab_ori_(1+nu_lab_ori));
n_u_lab_ori_(1+nu_lab_ori) = numel(index_lab_ori_);
index_lab_ori__{1+nu_lab_ori} = index_lab_ori_;
end;%for nu_lab_ori=0:n_u_lab_ori-1;
u_lab_color__ = [ ...
  0.5 0.1 0.8 ...
; 0.8 0.1 0.5 ...
; 1.0 0.9 0.9 ...
; 0.0 0.0 0.0 ...
; 0.0 0.0 0.0 ...
; 0.9 0.9 1.0 ...
; 0.0 0.0 0.0 ...
; 0.0 0.0 0.0 ...
; 0.0 0.0 0.0 ...
; 0.0 0.0 0.0 ...
];
lab_ori_color__ = zeros(size(lab_ori_,1),3);
for nu_lab_ori=0:n_u_lab_ori-1;
index_lab_ori_ = index_lab_ori__{1+nu_lab_ori};
n_u_lab_ori = n_u_lab_ori_(1+nu_lab_ori);
lab_ori_color__(1+index_lab_ori_,:) = repmat(u_lab_color__(1+nu_lab_ori,:),[n_u_lab_ori,1]);
end;%for nu_lab_ori=0:n_u_lab_ori-1;
%%%%%%%%;
sex_ori_ = T_{:,2};
isM_ori_ = cellfun(@(x)strcmp(x,'M'),sex_ori_);
isF_ori_ = cellfun(@(x)strcmp(x,'F'),sex_ori_);
age_ori_ = T_{:,4};
age_ori_M_ = age_ori_(1+efind(isM_ori_));
age_ori_F_ = age_ori_(1+efind(isF_ori_));
disp(sprintf(' %% A: %d prctile [ 5 15 20 30 65 70 85 95 ] %5.2f %5.2f %5.2f %5.2f %5.2f %5.2f %5.2f %5.2f ',numel(age_ori_),prctile(age_ori_,[ 5 15 20 30 65 70 85 95 ])));
disp(sprintf(' %% M: %d prctile [ 5 15 20 30 65 70 85 95 ] %5.2f %5.2f %5.2f %5.2f %5.2f %5.2f %5.2f %5.2f ',sum(isM_ori_),prctile(age_ori_M_,[ 5 15 20 30 65 70 85 95 ])));
disp(sprintf(' %% F: %d prctile [ 5 15 20 30 65 70 85 95 ] %5.2f %5.2f %5.2f %5.2f %5.2f %5.2f %5.2f %5.2f ',sum(isF_ori_),prctile(age_ori_F_,[ 5 15 20 30 65 70 85 95 ])));
h_age_ = 1:65;
h_age_M_ = hist(age_ori_M_,h_age_);
h_age_F_ = hist(age_ori_F_,h_age_);
%%%%%%%%;
fname_fig = sprintf('%s/dolphin_age_hist_MF',dir_jpg);
if (flag_replot | ~exist(sprintf('%s.jpg',fname_fig),'file'));
disp(sprintf(' %% %s not found, creating',fname_fig));
figure(1); clf; figmed; figbeach;
subplot(1,1,1);
bar(h_age_,[h_age_F_ ; h_age_M_],'grouped','BarWidth',1.5);
xlabel('age');
ylabel('number');
legend({'F','M'});
title('Histogram of ages for Female (blue) and Male (red) dolphins');
disp(sprintf(' %% writing %s',fname_fig));
print('-depsc',sprintf('%s.eps',fname_fig));
print('-djpeg',sprintf('%s.jpg',fname_fig));
close(gcf);
end;%if (~exist(sprintf('%s.jpg',fname_fig),'file'));
if ( exist(sprintf('%s.jpg',fname_fig),'file'));
disp(sprintf(' %% %s found, not creating',fname_fig));
end;%if ( exist(sprintf('%s.jpg',fname_fig),'file'));
%%%%%%%%;
nvar_base = 7;
dat_ori__ = T_{:,(1+nvar_base):end};
n_smp_ori = size(dat_ori__,1);
n_var_ori = size(dat_ori__,2);
string_dat_ori_name_ = cell(n_var_ori,1);
for nvar=0:n_var_ori-1;
string_dat_ori_name_{1+nvar} = T_.Properties.VariableNames{1+nvar_base+nvar};
end;%for nvar=0:n_var_ori-1;
%%%%%%%%;
flag_zero_as_missing_ = ones(n_var_ori,1);
flag_zero_as_missing_(1+efind(strcmp(string_dat_ori_name_,'NRBC'))) = 0;
flag_zero_as_missing_(1+efind(strcmp(string_dat_ori_name_,'Monocytes'))) = 0;
flag_zero_as_missing_(1+efind(strcmp(string_dat_ori_name_,'ACMonocytes'))) = 0;
flag_zero_as_missing_(1+efind(strcmp(string_dat_ori_name_,'UricAcid'))) = 0;
flag_zero_as_missing_(1+efind(strcmp(string_dat_ori_name_,'Bilirubin'))) = 0;
flag_zero_as_missing_(1+efind(strcmp(string_dat_ori_name_,'SED60'))) = 0;
%%%%;
flag_pseudocount_ = zeros(n_var_ori,1);
val_pseudocount_ = zeros(n_var_ori,1);
flag_pseudocount_(1+efind(strcmp(string_dat_ori_name_,'NRBC'))) = 1;
val_pseudocount_(1+efind(strcmp(string_dat_ori_name_,'NRBC'))) = 1;
flag_pseudocount_(1+efind(strcmp(string_dat_ori_name_,'Monocytes'))) = 1;
val_pseudocount_(1+efind(strcmp(string_dat_ori_name_,'Monocytes'))) = 1;
flag_pseudocount_(1+efind(strcmp(string_dat_ori_name_,'ACMonocytes'))) = 1;
val_pseudocount_(1+efind(strcmp(string_dat_ori_name_,'ACMonocytes'))) = 0.01;
flag_pseudocount_(1+efind(strcmp(string_dat_ori_name_,'EOS'))) = 1;
val_pseudocount_(1+efind(strcmp(string_dat_ori_name_,'EOS'))) = 1;
flag_pseudocount_(1+efind(strcmp(string_dat_ori_name_,'Creatinine'))) = 1;
val_pseudocount_(1+efind(strcmp(string_dat_ori_name_,'Creatinine'))) = 0.1;
flag_pseudocount_(1+efind(strcmp(string_dat_ori_name_,'UricAcid'))) = 1;
val_pseudocount_(1+efind(strcmp(string_dat_ori_name_,'UricAcid'))) = 0.1;
flag_pseudocount_(1+efind(strcmp(string_dat_ori_name_,'Potassium'))) = 1;
val_pseudocount_(1+efind(strcmp(string_dat_ori_name_,'Potassium'))) = 0.1;
flag_pseudocount_(1+efind(strcmp(string_dat_ori_name_,'CO2'))) = 1;
val_pseudocount_(1+efind(strcmp(string_dat_ori_name_,'CO2'))) = 1;
flag_pseudocount_(1+efind(strcmp(string_dat_ori_name_,'Protein'))) = 1;
val_pseudocount_(1+efind(strcmp(string_dat_ori_name_,'Protein'))) = 0.1;
flag_pseudocount_(1+efind(strcmp(string_dat_ori_name_,'Albumin'))) = 1;
val_pseudocount_(1+efind(strcmp(string_dat_ori_name_,'Albumin'))) = 0.1;
flag_pseudocount_(1+efind(strcmp(string_dat_ori_name_,'Calcium'))) = 1;
val_pseudocount_(1+efind(strcmp(string_dat_ori_name_,'Calcium'))) = 0.1;
flag_pseudocount_(1+efind(strcmp(string_dat_ori_name_,'InorgPhos'))) = 1;
val_pseudocount_(1+efind(strcmp(string_dat_ori_name_,'InorgPhos'))) = 0.1;
flag_pseudocount_(1+efind(strcmp(string_dat_ori_name_,'AlkPhos'))) = 1;
val_pseudocount_(1+efind(strcmp(string_dat_ori_name_,'AlkPhos'))) = 1;
flag_pseudocount_(1+efind(strcmp(string_dat_ori_name_,'ALT'))) = 1;
val_pseudocount_(1+efind(strcmp(string_dat_ori_name_,'ALT'))) = 1;
flag_pseudocount_(1+efind(strcmp(string_dat_ori_name_,'GGT'))) = 1;
val_pseudocount_(1+efind(strcmp(string_dat_ori_name_,'GGT'))) = 1;
flag_pseudocount_(1+efind(strcmp(string_dat_ori_name_,'Bilirubin'))) = 1;
val_pseudocount_(1+efind(strcmp(string_dat_ori_name_,'Bilirubin'))) = 0.1;
flag_pseudocount_(1+efind(strcmp(string_dat_ori_name_,'Triglyceride'))) = 1;
val_pseudocount_(1+efind(strcmp(string_dat_ori_name_,'Triglyceride'))) = 1;
flag_pseudocount_(1+efind(strcmp(string_dat_ori_name_,'Iron'))) = 1;
val_pseudocount_(1+efind(strcmp(string_dat_ori_name_,'Iron'))) = 1;
flag_pseudocount_(1+efind(strcmp(string_dat_ori_name_,'CPK'))) = 1;
val_pseudocount_(1+efind(strcmp(string_dat_ori_name_,'CPK'))) = 1;
flag_pseudocount_(1+efind(strcmp(string_dat_ori_name_,'SED60'))) = 1;
val_pseudocount_(1+efind(strcmp(string_dat_ori_name_,'SED60'))) = 1;
flag_pseudocount_(1+efind(strcmp(string_dat_ori_name_,'Mg'))) = 1;
val_pseudocount_(1+efind(strcmp(string_dat_ori_name_,'Mg'))) = 0.1;
flag_pseudocount_(1+efind(strcmp(string_dat_ori_name_,'GFR'))) = 1;
val_pseudocount_(1+efind(strcmp(string_dat_ori_name_,'GFR'))) = 4e-4;
%%%%;
flag_inv_transform_ = zeros(n_var_ori,1);
flag_inv_transform_(1+efind(strcmp(string_dat_ori_name_,'GFR'))) = 1;
%%%%;
flag_upb_threshold_ = zeros(n_var_ori,1);
val_upb_threshold_ = zeros(n_var_ori,1);
flag_upb_threshold_(1+efind(strcmp(string_dat_ori_name_,'RBCDist'))) = 1;
val_upb_threshold_(1+efind(strcmp(string_dat_ori_name_,'RBCDist'))) = 40;
%%%%;
flag_lob_threshold_ = zeros(n_var_ori,1);
val_lob_threshold_ = zeros(n_var_ori,1);
flag_lob_threshold_(1+efind(strcmp(string_dat_ori_name_,'Albumin'))) = 1;
val_lob_threshold_(1+efind(strcmp(string_dat_ori_name_,'Albumin'))) = 2;
flag_lob_threshold_(1+efind(strcmp(string_dat_ori_name_,'GFR'))) = 1;
val_lob_threshold_(1+efind(strcmp(string_dat_ori_name_,'GFR'))) = 100;
%%%%;

%%%%%%%%;
flag_log_transform_ = zeros(n_var_ori,1);
age_lob =  0; age_upb = 55;
for nvar_ori=0:n_var_ori-1;
string_dat_ori_name = string_dat_ori_name_{1+nvar_ori};
tmp_aid_ori_ = aid_ori_(1+index_smp_TT_);
tmp_lab_ori_ = lab_ori_(1+index_smp_TT_);
tmp_lab_ori_color__ = lab_ori_color__(1+index_smp_TT_,:);
tmp_sex_ori_ = sex_ori_(1+index_smp_TT_);
tmp_age_ori_ = age_ori_(1+index_smp_TT_);
tmp_dat_ori_ = dat_ori__(1+index_smp_TT_,1+nvar_ori);
flag_zero_as_missing = flag_zero_as_missing_(1+nvar_ori);
if flag_zero_as_missing; tmp_dat_ori_(1+efind(tmp_dat_ori_==0)) = NaN; end;%if flag_zero_as_missing;
flag_upb_threshold = flag_upb_threshold_(1+nvar_ori);
if flag_upb_threshold;
val_upb_threshold = val_upb_threshold_(1+nvar_ori);
tmp_dat_ori_(1+efind(tmp_dat_ori_> val_upb_threshold)) = NaN;
end;%if flag_upb_threshold;
flag_lob_threshold = flag_lob_threshold_(1+nvar_ori);
if flag_lob_threshold;
val_lob_threshold = val_lob_threshold_(1+nvar_ori);
tmp_dat_ori_(1+efind(tmp_dat_ori_< val_lob_threshold)) = NaN;
end;%if flag_lob_threshold;
flag_inv_transform = flag_inv_transform_(1+nvar_ori);
if flag_inv_transform; tmp_dat_ori_ = 1./tmp_dat_ori_; end;
tmp_index_use_ = efind( isfinite(tmp_age_ori_) & isfinite(tmp_dat_ori_) & (tmp_age_ori_>=age_lob) & (tmp_age_ori_<=age_upb) );
p_use = numel(tmp_index_use_)/numel(index_smp_TT_);
tmp_aid_use_ = tmp_aid_ori_(1+tmp_index_use_);
tmp_lab_use_ = tmp_lab_ori_(1+tmp_index_use_);
tmp_lab_color_use__ = tmp_lab_ori_color__(1+tmp_index_use_,:);
tmp_sex_use_ = tmp_sex_ori_(1+tmp_index_use_);
tmp_age_use_ = tmp_age_ori_(1+tmp_index_use_);
tmp_dat_use_ = tmp_dat_ori_(1+tmp_index_use_);
tmp_dat_p01 = prctile(tmp_dat_use_,01);
tmp_dat_p99 = prctile(tmp_dat_use_,99);
ddat = 0;
flag_pseudocount = flag_pseudocount_(1+nvar_ori);
if flag_pseudocount; ddat = val_pseudocount_(1+nvar_ori); end;%if flag_pseudocount;
tmp_log_use_ = log(ddat + tmp_dat_use_);
tmp_log_p01 = prctile(tmp_log_use_,01);
tmp_log_p99 = prctile(tmp_log_use_,99);
tmp_index_dat_use_mid_ = efind( (tmp_dat_use_>=tmp_dat_p01) & (tmp_dat_use_<=tmp_dat_p99) );
skewness_dat  = skewness(normalize(tmp_dat_use_(1+tmp_index_dat_use_mid_)));
skewness_log  = skewness(normalize(tmp_log_use_(1+tmp_index_dat_use_mid_)));
if (abs(skewness_dat)<=abs(skewness_log)); flag_log_transform = 0; end;
if (abs(skewness_dat)> abs(skewness_log)); flag_log_transform = 1; end;
disp(sprintf('nvar_ori %d: %s --> %0.2f %0.2f --> %d',nvar_ori,string_dat_ori_name,skewness_dat,skewness_log,flag_log_transform));
flag_log_transform_(1+nvar_ori) = flag_log_transform;
%%%%%%%%%%%%%%%%;
fname_fig = sprintf('%s/fig_log_transform_nvar%.2d_%s_FIGA',dir_jpg,nvar_ori,string_dat_ori_name);
if (flag_replot | ~exist(sprintf('%s.jpg',fname_fig),'file'));
disp(sprintf(' %% %s not found, creating',fname_fig));
figure(1+nf);nf=nf+1;clf;figbig;
sgtitle(sprintf('%s --> %0.2f %0.2f --> %d',string_dat_ori_name,skewness_dat,skewness_log,flag_log_transform));
ylim_ = [tmp_dat_p01,tmp_dat_p99]; ylim_ = mean(ylim_) + 0.5*1.5*diff(ylim_)*[-1,+1];
subplot(2,3,[1,2]); plot(tmp_age_use_,tmp_dat_use_,'k.');
xlim([0,55]); ylim(ylim_); xlabel('age'); ylabel(string_dat_ori_name); grid on;
subplot(2,3,3); hist(tmp_dat_use_,linspace(tmp_dat_p01,tmp_dat_p99,128)); title('hist');
ylim_ = [tmp_log_p01,tmp_log_p99]; ylim_ = mean(ylim_) + 0.5*1.5*diff(ylim_)*[-1,+1];
subplot(2,3,[4,5]); plot(tmp_age_use_,tmp_log_use_,'k.');
xlim([0,55]); ylim(ylim_); xlabel('age'); ylabel(string_dat_ori_name); grid on;
subplot(2,3,6); hist(tmp_log_use_,linspace(tmp_log_p01,tmp_log_p99,128)); title('hist log');
print('-djpeg',sprintf('%s.jpg',fname_fig));
print('-depsc',sprintf('%s.eps',fname_fig));
close(gcf);
%%%%%%%%;
end;%if (flag_replot | ~exist(sprintf('%s.jpg',fname_fig),'file'));
if ( exist(sprintf('%s.jpg',fname_fig),'file'));
disp(sprintf(' %% %s found, not creating',fname_fig));
end;%if ( exist(sprintf('%s.jpg',fname_fig),'file'));
%%%%%%%%%%%%%%%%;
if flag_log_transform;
string_dat_ori_name_title = sprintf('log(%s)',string_dat_ori_name);
tmp_dat_use_ = tmp_log_use_;
tmp_dat_p01 = tmp_log_p01;
tmp_dat_p99 = tmp_log_p99;
end;%if flag_log_transform;
tmp_index_dat_use_mid_ = efind( (tmp_dat_use_>=tmp_dat_p01) & (tmp_dat_use_<=tmp_dat_p99) );
fname_fig = sprintf('%s/fig_chebfit_nvar%.2d_%s_FIGA',dir_jpg,nvar_ori,string_dat_ori_name);
if (flag_replot | ~exist(sprintf('%s.jpg',fname_fig),'file'));
disp(sprintf(' %% %s not found, creating',fname_fig));
n_degree = 1;
[c_obj,x_value_use_,y_value_use_] = chebfit_safe_1(tmp_age_use_(1+tmp_index_dat_use_mid_),tmp_dat_use_(1+tmp_index_dat_use_mid_),n_degree);
figure(1+nf);nf=nf+1;clf;figbig;
sgtitle(sprintf('%s p %0.2f',string_dat_ori_name_title,p_use));
p_row = 3; p_col = 4; ns=0;
markersize_use = 4;
fontsize_use = 8;
sgtitle(sprintf('%s p %0.2f',string_dat_ori_name_title,p_use));
%%%%;
subplot(p_row,p_col,1+ns+[0:2]);ns=ns+3;
hold on;
tmp_index_ = efind(strcmp(tmp_sex_use_,'F'));
plot(tmp_age_use_(1+tmp_index_),tmp_dat_use_(1+tmp_index_),'ko','MarkerSize',markersize_use,'MarkerFaceColor',[0,0.5,1.0]);
tmp_index_ = efind(strcmp(tmp_sex_use_,'M'));
plot(tmp_age_use_(1+tmp_index_),tmp_dat_use_(1+tmp_index_),'ko','MarkerSize',markersize_use,'MarkerFaceColor',[1.0,0.5,0]);
plot(sort(tmp_age_use_),c_obj(sort(tmp_age_use_)),'r-','LineWidth',3);
hold off;
xlim([age_lob,age_upb]); xlabel('age');
ylim(prctile(tmp_dat_use_,[ 0.1,99.9]));
ylabel(string_dat_ori_name_title,'Interpreter','none');
title('sex');
grid on;
%%%%;
subplot(p_row,p_col,1+ns);ns=ns+1;
hist(tmp_dat_use_,linspace(prctile(tmp_dat_use_, 0.1),prctile(tmp_dat_use_,99.9),128));
title('histogram');
%%%%;
subplot(p_row,p_col,1+1*p_col+[0:p_col-1]);
hold on;
na=0; na_ = [0]; tmp_c_ = [1,0,0];
str_symbol_ = {'o','^','s','p','h'}; nsymbol=0;
for naid=0:n_u_aid_ori-1;
tmp_index_ = efind(tmp_aid_use_==u_aid_ori_(1+naid));
if (numel(tmp_index_)>0);
tmp_age_min = min(tmp_age_use_(1+tmp_index_));
tmp_age_max = max(tmp_age_use_(1+tmp_index_));
str_symbol = str_symbol_{1+nsymbol};
plot( ...
 1+na+(tmp_age_use_(1+tmp_index_)-tmp_age_min) ...
,tmp_dat_use_(1+tmp_index_) ...
,str_symbol ...
,'MarkerEdgeColor','k' ...
,'MarkerSize',markersize_use ...
,'MarkerFaceColor',tmp_c_ ...
);
na = na + (tmp_age_max - tmp_age_min) + 1;
na_ = [na_,na];
nsymbol = nsymbol+1; if (nsymbol>4); nsymbol=0; end;
tmp_c_ = 1-tmp_c_;
end;%if (numel(tmp_index_)>0);
end;%for naid=0:n_u_aid_ori-1;
hold off;
xlim([0,1+na]); xlabel('age'); set(gca,'XTick',na_);
ylim(prctile(tmp_dat_use_,[ 0.1,99.9]));
ylabel(string_dat_ori_name_title,'Interpreter','none');
title('aid');
grid on;
%%%%;
subplot(p_row,p_col,1+2*p_col+[0:p_col-1]);
hold on;
na=0; na_ = [0]; tmp_c_ = [1,0,0];
str_symbol_ = {'o','^','s','p','h'}; nsymbol=0;
for naid=0:n_u_aid_ori-1;
tmp_index_ = efind(tmp_aid_use_==u_aid_ori_(1+naid));
if (numel(tmp_index_)>0);
tmp_age_min = min(tmp_age_use_(1+tmp_index_));
tmp_age_max = max(tmp_age_use_(1+tmp_index_));
str_symbol = str_symbol_{1+nsymbol};
scatter( ...
 1+na+(tmp_age_use_(1+tmp_index_)-tmp_age_min) ...
,tmp_dat_use_(1+tmp_index_) ...
,markersize_use ...
,tmp_lab_color_use__(1+tmp_index_,:) ...
,'filled' ...
);
na = na + (tmp_age_max - tmp_age_min) + 1;
na_ = [na_,na];
nsymbol = nsymbol+1; if (nsymbol>4); nsymbol=0; end;
tmp_c_ = 1-tmp_c_;
end;%if (numel(tmp_index_)>0);
end;%for naid=0:n_u_aid_ori-1;
hold off;
xlim([0,1+na]); xlabel('age'); set(gca,'XTick',na_);
ylim(prctile(tmp_dat_use_,[ 0.1,99.9]));
ylabel(string_dat_ori_name_title,'Interpreter','none');
title('lab');
grid on;
%%%%;
print('-djpeg',sprintf('%s.jpg',fname_fig));
print('-depsc',sprintf('%s.eps',fname_fig));
close(gcf);
%%%%%%%%;
end;%if (flag_replot | ~exist(sprintf('%s.jpg',fname_fig),'file'));
if ( exist(sprintf('%s.jpg',fname_fig),'file'));
disp(sprintf(' %% %s found, not creating',fname_fig));
end;%if ( exist(sprintf('%s.jpg',fname_fig),'file'));
end;%for nvar_ori=0:n_var_ori-1;

nf=0;
index_smp_TT_ = efind(isTT_ori_);
age_lob =  0; age_upb = 55;
che_lob = 10; che_upb = 55;
n_degree = 1;
for nvar_ori=0:n_var_ori-1;%for nvar_ori=0:n_var_ori-1;
string_dat_ori_name = string_dat_ori_name_{1+nvar_ori};
disp(sprintf(' %% nvar_ori %d/%d --> %s',nvar_ori,n_var_ori,string_dat_ori_name));
fname_fig = sprintf('%s/fig_chebfit_nvar%.2d_%s_FIGA',dir_jpg,nvar_ori,string_dat_ori_name);
if (flag_replot | ~exist(sprintf('%s.jpg',fname_fig),'file'));
disp(sprintf(' %% %s not found, creating',fname_fig));
tmp_aid_ori_ = aid_ori_(1+index_smp_TT_);
tmp_lab_ori_ = lab_ori_(1+index_smp_TT_);
tmp_lab_ori_color__ = lab_ori_color__(1+index_smp_TT_,:);
tmp_sex_ori_ = sex_ori_(1+index_smp_TT_);
tmp_age_ori_ = age_ori_(1+index_smp_TT_);
tmp_dat_ori_ = dat_ori__(1+index_smp_TT_,1+nvar_ori);
flag_zero_as_missing = flag_zero_as_missing_(1+nvar_ori);
if flag_zero_as_missing; tmp_dat_ori_(1+efind(tmp_dat_ori_==0)) = NaN; end;%if flag_zero_as_missing;
tmp_index_use_ = efind( isfinite(tmp_age_ori_) & isfinite(tmp_dat_ori_) & (tmp_age_ori_>=age_lob) & (tmp_age_ori_<=age_upb) );
tmp_aid_use_ = tmp_aid_ori_(1+tmp_index_use_);
tmp_lab_use_ = tmp_lab_ori_(1+tmp_index_use_);
tmp_lab_color_use__ = tmp_lab_ori_color__(1+tmp_index_use_,:);
tmp_sex_use_ = tmp_sex_ori_(1+tmp_index_use_);
tmp_age_use_ = tmp_age_ori_(1+tmp_index_use_);
tmp_dat_use_ = tmp_dat_ori_(1+tmp_index_use_);
%tmp_dat_use_ = max(prctile(tmp_dat_use_, 0.1),min(prctile(tmp_dat_use_,99.9),tmp_dat_use_));
p_use = numel(tmp_index_use_)/numel(index_smp_TT_);
tmp_dat_srt_ = sort(tmp_dat_use_);
mdat = min(tmp_dat_srt_);
ddat = min(tmp_dat_srt_(find(tmp_dat_srt_>mdat)));
tmp_ldat_use_ = log( ddat + tmp_dat_use_ - mdat );
tmp_che_index_ = efind( (tmp_age_use_>=che_lob) & (tmp_age_use_<=che_upb) );
[c_obj,x_value_use_,y_value_use_] = chebfit_safe_1(tmp_age_use_(1+tmp_che_index_),tmp_dat_use_(1+tmp_che_index_),n_degree);
figure(1+nf);nf=nf+1;clf;figbig;
p_row = 3; p_col = 4; ns=0;
markersize_use = 4;
fontsize_use = 8;
sgtitle(sprintf('%s p %0.2f',string_dat_ori_name,p_use));
%%%%;
subplot(p_row,p_col,1+ns+[0:2]);ns=ns+3;
hold on;
tmp_index_ = efind(strcmp(tmp_sex_use_,'F'));
plot(tmp_age_use_(1+tmp_index_),tmp_dat_use_(1+tmp_index_),'ko','MarkerSize',markersize_use,'MarkerFaceColor',[0,0.5,1.0]);
tmp_index_ = efind(strcmp(tmp_sex_use_,'M'));
plot(tmp_age_use_(1+tmp_index_),tmp_dat_use_(1+tmp_index_),'ko','MarkerSize',markersize_use,'MarkerFaceColor',[1.0,0.5,0]);
plot(sort(tmp_age_use_),c_obj(sort(tmp_age_use_)),'r-','LineWidth',3);
hold off;
xlim([age_lob,age_upb]); xlabel('age');
ylim(prctile(tmp_dat_use_,[ 0.1,99.9]));
ylabel(string_dat_ori_name,'Interpreter','none');
title('sex');
grid on;
%%%%;
subplot(p_row,p_col,1+ns);ns=ns+1;
hist(tmp_dat_use_,linspace(prctile(tmp_dat_use_, 0.1),prctile(tmp_dat_use_,99.9),20));
title('histogram');
%%%%;
subplot(p_row,p_col,1+1*p_col+[0:p_col-1]);
hold on;
na=0; na_ = [0]; tmp_c_ = [1,0,0];
str_symbol_ = {'o','^','s','p','h'}; nsymbol=0;
for naid=0:n_u_aid_ori-1;
tmp_index_ = efind(tmp_aid_use_==u_aid_ori_(1+naid));
if (numel(tmp_index_)>0);
tmp_age_min = min(tmp_age_use_(1+tmp_index_));
tmp_age_max = max(tmp_age_use_(1+tmp_index_));
str_symbol = str_symbol_{1+nsymbol};
plot( ...
 1+na+(tmp_age_use_(1+tmp_index_)-tmp_age_min) ...
,tmp_dat_use_(1+tmp_index_) ...
,str_symbol ...
,'MarkerEdgeColor','k' ...
,'MarkerSize',markersize_use ...
,'MarkerFaceColor',tmp_c_ ...
);
na = na + (tmp_age_max - tmp_age_min) + 1;
na_ = [na_,na];
nsymbol = nsymbol+1; if (nsymbol>4); nsymbol=0; end;
tmp_c_ = 1-tmp_c_;
end;%if (numel(tmp_index_)>0);
end;%for naid=0:n_u_aid_ori-1;
hold off;
xlim([0,1+na]); xlabel('age'); set(gca,'XTick',na_);
ylim(prctile(tmp_dat_use_,[ 0.1,99.9]));
ylabel(string_dat_ori_name,'Interpreter','none');
title('aid');
grid on;
%%%%;
subplot(p_row,p_col,1+2*p_col+[0:p_col-1]);
hold on;
na=0; na_ = [0]; tmp_c_ = [1,0,0];
str_symbol_ = {'o','^','s','p','h'}; nsymbol=0;
for naid=0:n_u_aid_ori-1;
tmp_index_ = efind(tmp_aid_use_==u_aid_ori_(1+naid));
if (numel(tmp_index_)>0);
tmp_age_min = min(tmp_age_use_(1+tmp_index_));
tmp_age_max = max(tmp_age_use_(1+tmp_index_));
str_symbol = str_symbol_{1+nsymbol};
scatter( ...
 1+na+(tmp_age_use_(1+tmp_index_)-tmp_age_min) ...
,tmp_dat_use_(1+tmp_index_) ...
,markersize_use ...
,tmp_lab_color_use__(1+tmp_index_,:) ...
,'filled' ...
);
na = na + (tmp_age_max - tmp_age_min) + 1;
na_ = [na_,na];
nsymbol = nsymbol+1; if (nsymbol>4); nsymbol=0; end;
tmp_c_ = 1-tmp_c_;
end;%if (numel(tmp_index_)>0);
end;%for naid=0:n_u_aid_ori-1;
hold off;
xlim([0,1+na]); xlabel('age'); set(gca,'XTick',na_);
ylim(prctile(tmp_dat_use_,[ 0.1,99.9]));
ylabel(string_dat_ori_name,'Interpreter','none');
title('lab');
grid on;
%%%%;
print('-djpeg',sprintf('%s.jpg',fname_fig));
print('-depsc',sprintf('%s.eps',fname_fig));
close(gcf);
%%%%%%%%;
end;%if (flag_replot | ~exist(sprintf('%s.jpg',fname_fig),'file'));
if ( exist(sprintf('%s.jpg',fname_fig),'file'));
disp(sprintf(' %% %s found, not creating',fname_fig));
end;%if ( exist(sprintf('%s.jpg',fname_fig),'file'));
end;%for nvar_ori=0:n_var_ori-1;


%%%%%%%%;
% log-normalizing SED60 and GGT. ;
%%%%%%%%;
nvar = efind(strcmp(string_dat_ori_name_,'SED60'));
dat_ori__(:,1+nvar) = log(1+dat_ori__(:,1+nvar));
string_dat_ori_name_{1+nvar} = sprintf('log(1+%s)',string_dat_ori_name_{1+nvar});
nvar = efind(strcmp(string_dat_ori_name_,'GGT'));
dat_ori__(:,1+nvar) = log(1+dat_ori__(:,1+nvar));
string_dat_ori_name_{1+nvar} = sprintf('log(1+%s)',string_dat_ori_name_{1+nvar});
%%%%%%%%;
% removing RBCDist values above 40. ;
%%%%%%%%;
tmp_index_var_ = efind(strcmp(string_dat_ori_name_,'RBCDist'));
tmp_index_smp_ = efind(dat_ori__(:,1+tmp_index_var_)> 40);
dat_ori__(1+tmp_index_smp_,1+tmp_index_var_) = NaN;
%%%%%%%%;
% removing Albumin values below 2.5. ;
%%%%%%%%;
tmp_index_var_ = efind(strcmp(string_dat_ori_name_,'Albumin'));
tmp_index_smp_ = efind(dat_ori__(:,1+tmp_index_var_)<=2.5);
dat_ori__(1+tmp_index_smp_,1+tmp_index_var_) = NaN;
%%%%%%%%;
% removing NRBC values above 20. ;
%%%%%%%%;
tmp_index_var_ = efind(strcmp(string_dat_ori_name_,'NRBC'));
tmp_index_smp_ = efind(dat_ori__(:,1+tmp_index_var_)> 20);
dat_ori__(1+tmp_index_smp_,1+tmp_index_var_) = NaN;

index_smp_TT_ = efind(isTT_ori_);
nvar_ori_Lymphs = efind(strcmp(string_dat_ori_name_,'Lymphs'));
tmp_age_ori_ = age_ori_(1+index_smp_TT_);
tmp_dat_ori_ = dat_ori__(1+index_smp_TT_,1+nvar_ori_Lymphs);
tmp_lab_ori_ = lab_ori_(1+index_smp_TT_);
tmp_p_coef_ = polyfit_safe_0(tmp_age_ori_,tmp_dat_ori_,2);
c_lines__ = colormap('lines'); n_c_lines = size(c_lines__,1);
hold on;
plot(tmp_age_ori_,tmp_dat_ori_,'k.',sort(tmp_age_ori_),polyval(tmp_p_coef_,sort(tmp_age_ori_)),'r-');
for nlab=4:13;
tmp_index_ = efind(tmp_lab_ori_==nlab);
nc_lines = nlab-4;
plot(tmp_age_ori_(1+tmp_index_),tmp_dat_ori_(1+tmp_index_),'ko','MarkerFaceColor',c_lines__(1+nc_lines,:));
end;%for nlab=4:13;
hold off;

%%%%%%%%;
% color by lab. ;
%%%%%%%%;
index_smp_TT_ = efind(isTT_ori_);
nvar_ori_GFR = efind(strcmp(string_dat_ori_name_,'GFR'));
tmp_age_ori_ = age_ori_(1+index_smp_TT_);
tmp_dat_ori_ = dat_ori__(1+index_smp_TT_,1+nvar_ori_GFR);
tmp_lab_ori_ = lab_ori_(1+index_smp_TT_);
%tmp_p_coef_ = polyfit_safe_0(tmp_age_ori_,tmp_dat_ori_,2);
[c_obj,x_value_use_,y_value_use_] = chebfit_safe_1(tmp_age_ori_,tmp_dat_ori_);
c_lines__ = colormap('lines'); n_c_lines = size(c_lines__,1);
figure(1);clf;figmed;
markersize_use=4;
hold on;
%plot(tmp_age_ori_,tmp_dat_ori_,'k.');
%plot(sort(tmp_age_ori_),polyval(tmp_p_coef_,sort(tmp_age_ori_)),'r-','LineWidth',3);
plot(sort(tmp_age_ori_),c_obj(sort(tmp_age_ori_)),'r-','LineWidth',3);
for nlab=4:13;
tmp_index_ = efind(tmp_lab_ori_==nlab);
nc_lines = nlab-4;
plot(tmp_age_ori_(1+tmp_index_),tmp_dat_ori_(1+tmp_index_),'ko','MarkerFaceColor',c_lines__(1+nc_lines,:),'MarkerSize',markersize_use);
end;%for nlab=4:13;
hold off;

%%%%%%%%;
% color by dolphin. ;
% also log-normalize. ;
%%%%%%%%;
index_smp_TT_ = efind(isTT_ori_);
nvar_ori_GFR = efind(strcmp(string_dat_ori_name_,'GFR'));
tmp_age_ori_ = age_ori_(1+index_smp_TT_);
tmp_dat_ori_ = log(1+dat_ori__(1+index_smp_TT_,1+nvar_ori_GFR));
tmp_lab_ori_ = lab_ori_(1+index_smp_TT_);
%tmp_p_coef_ = polyfit_safe_0(tmp_age_ori_,tmp_dat_ori_,2);
[c_obj,x_value_use_,y_value_use_] = chebfit_safe_1(tmp_age_ori_,tmp_dat_ori_);
c_hsv__ = colormap('hsv'); n_c_hsv = size(c_hsv__,1);
figure(1);clf;figmed;
markersize_use=6;
hold on;
%plot(tmp_age_ori_,tmp_dat_ori_,'k.');
%plot(sort(tmp_age_ori_),polyval(tmp_p_coef_,sort(tmp_age_ori_)),'r-','LineWidth',3);
plot(sort(tmp_age_ori_),c_obj(sort(tmp_age_ori_)),'r-','LineWidth',3);
str_symbol_ = {'o-','^-','s-','p-','h-'};
for nu_aid_ori=0:n_u_aid_ori-1;
tmp_index_ = index_aid_ori__{1+nu_aid_ori};
str_symbol = str_symbol_{1+mod(nu_aid_ori,5)};
nc_hsv = max(0,min(n_c_hsv-1,floor(n_c_hsv*nu_aid_ori/n_u_aid_ori)));
plot(age_ori_(1+tmp_index_),log(1+dat_ori__(1+tmp_index_,1+nvar_ori_GFR)),str_symbol,'MarkerEdgeColor','k','MarkerFaceColor',c_hsv__(1+nc_hsv,:),'MarkerSize',markersize_use,'LineWidth',1.5);
end;%for nu_aid_ori=0:n_u_aid_ori-1;
hold off;

figure(1);clf;figbig;
index_smp_TT_ = efind(isTT_ori_);
for nvar_ori_local=0:n_var_ori-1;
tmp_age_ori_ = age_ori_(1+index_smp_TT_);
tmp_dat_ori_ = dat_ori__(1+index_smp_TT_,1+nvar_ori_local);
tmp_lab_ori_ = lab_ori_(1+index_smp_TT_);
tmp_p_coef_ = polyfit_safe_0(tmp_age_ori_,tmp_dat_ori_,2);
subplot(5,9,1+nvar_ori_local); cla;
c_lines__ = colormap('lines'); n_c_lines = size(c_lines__,1);
hold on;
plot(tmp_age_ori_,tmp_dat_ori_,'k.',sort(tmp_age_ori_),polyval(tmp_p_coef_,sort(tmp_age_ori_)),'r-');
for nlab=4:13;
tmp_index_ = efind(tmp_lab_ori_==nlab);
nc_lines = nlab-4;
plot(tmp_age_ori_(1+tmp_index_),tmp_dat_ori_(1+tmp_index_),'ko','MarkerFaceColor',c_lines__(1+nc_lines,:));
end;%for nlab=4:13;
hold off;
title(string_dat_ori_name_{1+nvar_ori_local});
end;%for nvar_ori_local=0:n_var_ori-1;

index_smp_TT_ = efind(isTT_ori_);
nvar_ori_AlkPhos = efind(strcmp(string_dat_ori_name_,'AlkPhos'));
tmp_age_ori_ = age_ori_(1+index_smp_TT_);
tmp_dat_ori_ = dat_ori__(1+index_smp_TT_,1+nvar_ori_AlkPhos);
tmp_p_coef_ = polyfit_safe_0(tmp_age_ori_,tmp_dat_ori_,2);
[c_obj,x_value_use_,y_value_use_] = chebfit_safe_1(tmp_age_ori_,tmp_dat_ori_);
clf;
hold on;
plot(tmp_age_ori_,tmp_dat_ori_,'k.',sort(tmp_age_ori_),polyval(tmp_p_coef_,sort(tmp_age_ori_)),'g-');
plot(sort(x_value_use_),c_obj(sort(x_value_use_)),'r-');
hold off;

index_smp_TT_ = efind(isTT_ori_);
nvar_ori_ACLymphocytes = efind(strcmp(string_dat_ori_name_,'ACLymphocytes'));
tmp_age_ori_ = age_ori_(1+index_smp_TT_);
tmp_dat_ori_ = dat_ori__(1+index_smp_TT_,1+nvar_ori_ACLymphocytes);
tmp_p_coef_ = polyfit_safe_0(tmp_age_ori_,tmp_dat_ori_,2);
plot(tmp_age_ori_,tmp_dat_ori_,'k.',sort(tmp_age_ori_),polyval(tmp_p_coef_,sort(tmp_age_ori_)),'r-');

flag_plot=1;
[x_value_,tmp_ij] = sort(tmp_age_ori_);
y_value_ = tmp_dat_ori_(tmp_ij);
%x_value_ = sort(randn(64,1));
%y_value_ = x_value_.^2 + randn(size(x_value_));
n_degree_ = 1:32; n_n_degree = numel(n_degree_);
loglikelihood_per__ = [];
loglikelihood_ = zeros(n_n_degree,1);
bic_ = zeros(n_n_degree,1);
if flag_plot;
figure(1);clf;figsml;
hold on;
plot(x_value_,y_value_,'k.');
hold off;
end;%if flag_plot;
for nn_degree=0:n_n_degree-1;
n_degree = n_degree_(1+nn_degree);
[c_obj,x_value_use_,y_value_use_] = chebfit_safe_0(x_value_,y_value_,n_degree);
if flag_plot;
hold on;
plot(x_value_use_,c_obj(x_value_use_),'r-');
hold off;
end;%if flag_plot;
y_value_use_std = std(y_value_use_,1);
residual_ = y_value_use_ - c_obj(x_value_use_);
residual_std = std(residual_,1);
%loglikelihood_per_ = -residual_.^2/(2*residual_std^2);
loglikelihood_per_ = -residual_.^2/(2*y_value_use_std^2);
loglikelihood_per__(:,1+nn_degree) = loglikelihood_per_;
loglikelihood = sum(loglikelihood_per_);
loglikelihood_(1+nn_degree) = loglikelihood;
bic = (1+n_degree)*log(numel(y_value_use_)) - 2*loglikelihood;
bic_(1+nn_degree) = bic;
end;%for nn_degree=0:n_n_degree-1;
if flag_plot;
[~,nndegree_opt] = min(bic_); nndegree_opt = nndegree_opt-1;
n_degree = n_degree_(1+nndegree_opt);
[c_obj,x_value_use_,y_value_use_] = chebfit_safe_0(x_value_,y_value_,n_degree);
hold on;
plot(x_value_use_,c_obj(x_value_use_),'g-','LineWidth',2);
hold off;
xlabel('x'); ylabel('y');
end;%if flag_plot;

n_degree_ = 2:3; n_n_degree = numel(n_degree_);
n_patch_ = 2:16; n_n_patch = numel(n_patch_);
bic__ = zeros(n_n_degree,n_n_patch);
for nn_degree=0:n_n_degree-1;
for nn_patch=0:n_n_patch-1;
n_degree = n_degree_(1+nn_degree);
n_patch = n_patch_(1+nn_patch);
x_edge_ = linspace(0,55,1+n_patch);
n_dof = n_patch*(1+n_degree) - (2 + 2*(n_patch-1));
C__ = polyspline_constraint_0(n_patch,x_edge_,n_degree);
[x_value_,tmp_ij] = sort(tmp_age_ori_);
y_value_ = tmp_dat_ori_(tmp_ij);
%%%%;
[ ...
 A__ ...
,x_value_use_ ...
,y_value_use_ ...
] = ...
polyspline_evaluate_0( ...
 n_patch ...
,x_edge_ ...
,n_degree ...
,x_value_ ...
,y_value_ ...
);
%%%%;
VCperp__ = null(C__); assert(size(VCperp__,2)>=n_dof);
AVCperp__ = A__*VCperp__;
ptilde_ = AVCperp__\y_value_use_;
pcoef_ = VCperp__*ptilde_;
residual_ = y_value_use_ - A__*pcoef_;
residual_std = std(residual_,1);
y_value_use_std = std(y_value_use_,1);
loglikelihood_ = -residual_.^2/(2*y_value_use_std^2);
loglikelihood = sum(loglikelihood_);
bic = size(VCperp__,2)*log(numel(y_value_use_)) - 2*loglikelihood;
bic__(1+nn_degree,1+nn_patch) = bic;
end;%for nn_patch=0:n_n_patch-1;
end;%for nn_degree=0:n_n_degree-1;

%%%%%%%%;
% Now examine chebfig_safe_1 across all variables. ;
%%%%%%%%;
figure(1);clf;figbig;
index_smp_TT_ = efind(isTT_ori_);
for nvar_ori=0:n_var_ori-1;
tmp_age_ori_ = age_ori_(1+index_smp_TT_);
tmp_dat_ori_ = dat_ori__(1+index_smp_TT_,1+nvar_ori);
[c_obj,x_value_use_,y_value_use_,bic_] = chebfit_safe_1(tmp_age_ori_,tmp_dat_ori_);
[~,n_degree_use] = min(bic_); n_degree_use=n_degree_use-1;
subplot(5,9,1+nvar_ori);
hold on;
plot(x_value_use_,y_value_use_,'k.');
plot(sort(x_value_use_),c_obj(sort(x_value_use_)),'r-','LineWidth',3);
hold off;
ylim(prctile(y_value_use_,[ 0.1,99.9]));
title(string_dat_ori_name_{1+nvar_ori});
end;%for nvar_ori=0:n_var_ori-1;

%{
%%%%%%%%;
% Now find principal-components using chebfig_safe_1. ;
%%%%%%%%;
%figure(1);figbig;
n_degree = 8;
c_obj_ = cell(n_var_ori,1);
dat_avg_ = zeros(n_var_ori,1);
dat_std_ = zeros(n_var_ori,1);
tmp_age_ori_ = age_ori_(1+index_smp_TT_);
for nvar_ori=0:n_var_ori-1;
tmp_dat_ori_ = dat_ori__(1+index_smp_TT_,1+nvar_ori);
tmp_index_ = efind( isfinite(tmp_age_ori_) & isfinite(tmp_dat_ori_) );
tmp_age_use_ = tmp_age_ori_(1+tmp_index_);
tmp_dat_use_ = tmp_dat_ori_(1+tmp_index_);
dat_avg = mean(tmp_dat_use_);
dat_std = std(tmp_dat_use_,1);
dat_avg_(1+nvar_ori) = dat_avg;
dat_std_(1+nvar_ori) = dat_std;
tmp_dat_nrm_ = (tmp_dat_use_ - dat_avg)/max(1e-12,dat_std);
[c_obj] = chebfit_safe_1(tmp_age_use_,tmp_dat_nrm_,n_degree);
c_obj_{1+nvar_ori} = c_obj;
%subplot(5,9,1+nvar_ori);
%plot(tmp_age_use_,tmp_dat_nrm_,'k.',sort(tmp_age_use_),c_obj(sort(tmp_age_use_)),'r-','LineWidth',2);
%ylim(prctile(tmp_dat_nrm_, 0.1,99.9));
%title(string_dat_ori_name_{1+nvar_ori});
end;%for nvar_ori=0:n_var_ori-1;
n_age_uni = 48;
age_uni_ = transpose(linspace(10,40,n_age_uni));
c_obj_uni__ = zeros(n_age_uni,n_var_ori);
for nvar_ori=0:n_var_ori-1;
c_obj = c_obj_{1+nvar_ori};
c_obj_uni_ = c_obj(age_uni_);
c_obj_uni__(:,1+nvar_ori) = c_obj_uni_;
end;%for nvar_ori=0:n_var_ori-1;
[Uc__,Sc__,Vc__] = svd(c_obj_uni__); Sc_ = diag(Sc__);
age_hi_ = age_uni_> 30; age_lo_ = (age_uni_> 10) & (age_uni_<=30);
tmp_index_ = efind(age_hi_+age_lo_);
[~,~,VL_n__,SL_n__] = SVD_discat_0(c_obj_uni__(1+tmp_index_,:),age_hi_(tmp_index_),3); SL_n_ = diag(SL_n_);
USL_n__ = c_obj_uni__*VL_n__;
figure(2);figsml; fig80s;
c_80s__ = colormap_80s; n_c_80s = size(c_80s__,1);
hold on;
%s=surfline_0(Uc__(:,1),Uc__(:,2),age_uni_); set(s,'LineWidth',8);
for nage_uni=0:n_age_uni-1-1;
nc_80s = max(0,min(n_c_80s-1,floor(n_c_80s*(age_uni_(1+nage_uni)-min(age_uni_))/max(age_uni_))));
%plot3(Uc__(1+nage_uni+[0:1],1),Uc__(1+nage_uni+[0:1],2),Uc__(1+nage_uni+[0:1],3),'Color',c_80s__(1+nc_80s,:),'LineWidth',8);
plot3(USL_n__(1+nage_uni+[0:1],1),USL_n__(1+nage_uni+[0:1],2),USL_n__(1+nage_uni+[0:1],3),'Color',c_80s__(1+nc_80s,:),'LineWidth',8);
end;%for nage_uni=0:n_age_uni-1-1;
hold off;
%%%%%%%%;
n_dat_use_lob = 32;
for nu_aid_ori=0:128;%for nu_aid_ori=0:n_u_aid_ori-1;
u_aid_ori = u_aid_ori_(1+nu_aid_ori);
index_smp_local_ = index_aid_ori__{1+nu_aid_ori};
c_obj_local_ = cell(n_var_ori,1);
tmp_age_ori_ = age_ori_(1+index_smp_local_);
flag_use=1;
for nvar_ori=0:n_var_ori-1;
tmp_dat_ori_ = dat_ori__(1+index_smp_local_,1+nvar_ori);
tmp_index_ = efind( isfinite(tmp_age_ori_) & isfinite(tmp_dat_ori_) );
n_dat_use = numel(tmp_index_);
if (n_dat_use< n_dat_use_lob); flag_use = 0; end;
if (n_dat_use>=n_dat_use_lob);
tmp_age_use_ = tmp_age_ori_(1+tmp_index_);
tmp_dat_use_ = tmp_dat_ori_(1+tmp_index_);
dat_avg = dat_avg_(1+nvar_ori);
dat_std = dat_std_(1+nvar_ori);
tmp_dat_nrm_ = (tmp_dat_use_ - dat_avg)/max(1e-12,dat_std);
[c_obj_local] = chebfit_safe_1(tmp_age_use_,tmp_dat_nrm_,n_degree);
c_obj_local_{1+nvar_ori} = c_obj_local;
end;%if (n_dat_use>=n_dat_use_lob);
end;%for nvar_ori=0:n_var_ori-1;
if flag_use;
n_age_local_uni = 24;
age_local_uni_ = transpose(linspace(min(tmp_age_ori_),max(tmp_age_ori_),n_age_local_uni));
c_obj_local_uni__ = zeros(n_age_local_uni,n_var_ori);
for nvar_ori=0:n_var_ori-1;
c_obj_local = c_obj_local_{1+nvar_ori};
c_obj_local_uni_ = c_obj_local(age_local_uni_);
c_obj_local_uni__(:,1+nvar_ori) = c_obj_local_uni_;
end;%for nvar_ori=0:n_var_ori-1;
%Uc_local__ = c_obj_local_uni__*Vc__*inv(diag(Sc_));
Uc_local__ = c_obj_local_uni__*VL_n__;
hold on;
for nage_local_uni=0:n_age_local_uni-1-1;
nc_80s = max(0,min(n_c_80s-1,floor(n_c_80s*(age_local_uni_(1+nage_local_uni)-min(age_uni_))/max(age_uni_))));
plot3(Uc_local__(1+nage_local_uni+[0:1],1),Uc_local__(1+nage_local_uni+[0:1],2),Uc_local__(1+nage_local_uni+[0:1],3),'Color',c_80s__(1+nc_80s,:),'LineWidth',2);
end;%for nage_local_uni=0:n_age_local_uni-1-1;
hold off;
end;%if flag_use;
end;%for nu_aid_ori=0:n_u_aid_ori-1;
%%%%%%%%;
%tmp_ = prctile(USL_n__(:,1),[ 1,99]); xlim(mean(tmp_) + diff(tmp_)*0.5*2.5*[-1,+1]);
%tmp_ = prctile(USL_n__(:,2),[ 1,99]); ylim(mean(tmp_) + diff(tmp_)*0.5*2.5*[-1,+1]);
%tmp_ = prctile(USL_n__(:,3),[ 1,99]); zlim(mean(tmp_) + diff(tmp_)*0.5*2.5*[-1,+1]);
axis vis3d;
%}

%%%%%%%%;
% Now pick one of the variables, say AlkPhos, and then plot the chebfit_safe_1 ;
% for all the dolphins, as well as each dolphin individually. ;
% Then plot the residual using population-mean, ;
% as well as residual using individual means. ;
%%%%%%%%;
n_dat_use_lob = 32;
index_smp_TT_ = efind(isTT_ori_);
nvar_ori_AlkPhos = efind(strcmp(string_dat_ori_name_,'AlkPhos'));
tmp_age_ori_ = age_ori_(1+index_smp_TT_);
tmp_dat_ori_ = dat_ori__(1+index_smp_TT_,1+nvar_ori_AlkPhos);
[c_obj,x_value_use_,y_value_use_,bic_] = chebfit_safe_1(tmp_age_ori_,tmp_dat_ori_);
[~,n_degree_use] = min(bic_); n_degree_use=n_degree_use-1;
figure(1);clf;figsml; title('all');
hold on;
plot(x_value_use_,y_value_use_,'k.');
plot(sort(x_value_use_),c_obj(sort(x_value_use_)),'r-','LineWidth',3);
hold off;
figure(2);clf;figsml; title('resid all');
hold on;
plot(x_value_use_,y_value_use_ - c_obj(x_value_use_),'k.');
hold off;
figure(3);clf;figsml; title('resid each');
for nu_aid_ori=0:n_u_aid_ori-1;
u_aid_ori = u_aid_ori_(1+nu_aid_ori);
tmp_index_ = index_aid_ori__{1+nu_aid_ori};
tmp_age_ori_ = age_ori_(1+tmp_index_);
tmp_dat_ori_ = dat_ori__(1+tmp_index_,1+nvar_ori_AlkPhos);
if (numel(tmp_age_ori_)>=n_dat_use_lob);
[tmp_c_obj,tmp_x_value_use_,tmp_y_value_use_] = chebfit_safe_1(tmp_age_ori_,tmp_dat_ori_,n_degree_use);
figure(1);
hold on;
plot(sort(tmp_x_value_use_),tmp_c_obj(sort(tmp_x_value_use_)),'g-','LineWidth',1);
hold off;
figure(3);
hold on;
plot(tmp_x_value_use_,tmp_y_value_use_ - tmp_c_obj(tmp_x_value_use_),'g.');
hold off;
end;%if (numel(tmp_age_ori_)>=n_degree_use+1);
end;%for nu_aid_ori=0:n_u_aid_ori-1;


%%%%%%%%;
% missingness threshold for variables. ;
%%%%%%%%;
dat_ret__ = dat_ori__;
mss_var_threshold = 500;
index_var_rmv_ = efind(sum(~isfinite(dat_ret__),1)>mss_var_threshold);
index_var_ret_ = setdiff(0:n_var_ori-1,index_var_rmv_);
dat_ret__ = dat_ret__(:,1+index_var_ret_);
n_var_ret = size(dat_ret__,2);
string_dat_ret_name_ = cell(n_var_ret,1);
for nvar=0:n_var_ret-1;
string_dat_ret_name_{1+nvar} = string_dat_ori_name_{1+index_var_ret_(1+nvar)};
end;%for nvar=0:n_var_ret-1;
%%%%%%%%;
% removing RBCDist values above 40 and Albumin values below 2.5. ;
%%%%%%%%;
tmp_index_var_ = efind(strcmp(string_dat_ret_name_,'RBCDist'));
tmp_index_smp_ = efind(dat_ret__(:,1+tmp_index_var_)> 40);
dat_ret__(1+tmp_index_smp_,1+tmp_index_var_) = NaN;
tmp_index_var_ = efind(strcmp(string_dat_ret_name_,'Albumin'));
tmp_index_smp_ = efind(dat_ret__(:,1+tmp_index_var_)<=2.5);
dat_ret__(1+tmp_index_smp_,1+tmp_index_var_) = NaN;
%%%%%%%%;
% constrain samples. ;
%%%%%%%%;
index_smp_ret_ = 0:n_smp_ori-1;
%%%%%%%%;
% missingness threshold for samples. ;
%%%%%%%%;
mss_smp_threshold = 7;
index_smp_ret_ = setdiff(index_smp_ret_,efind(sum(~isfinite(dat_ret__),2)>mss_smp_threshold));
%%%%%%%%;
% sex constrain ;
%%%%%%%%;
if ~isempty(sex_constrain);
index_smp_ret_ = setdiff(index_smp_ret_,efind(~cellfun(@(x)strcmp(x,sex_constrain),sex_ori_)));
end;%if ~isempty(sex_constrain);
%%%%%%%%;
dat_ret__ = dat_ret__(1+index_smp_ret_,:);
n_smp_ret = size(dat_ret__,1);
%%%%%%%%;
% check sample constraints. ;
%%%%%%%%;
for nsmp_ret=0:n_smp_ret-1;
assert(sum(~isfinite(dat_ret__(1+nsmp_ret,:)))<=mss_smp_threshold);
if ~isempty(sex_constrain);
assert(strcmp(sex_ori_{1+index_smp_ret_(1+nsmp_ret)},sex_constrain));
end;%if ~isempty(sex_constrain);
end;%for nsmp_ret=0:n_smp_ret-1;

aid_ret_ = aid_ori_(1+index_smp_ret_);
sex_ret_ = sex_ori_(1+index_smp_ret_);
age_ret_ = age_ori_(1+index_smp_ret_);

aid_ = aid_ret_;
sex_ = sex_ret_;
age_ = age_ret_;
dat_nrm__ = dat_ret__;
[n_smp,n_var] = size(dat_nrm__);
string_dat_name_ = string_dat_ret_name_;
prctile_threshold = 0.01;
for nvar=0:n_var-1;
tmp_index_ = efind(isfinite(dat_nrm__(:,1+nvar)));
tmp_lo = prctile(dat_nrm__(1+tmp_index_,1+nvar),100*prctile_threshold);
tmp_hi = prctile(dat_nrm__(1+tmp_index_,1+nvar),100*(1-prctile_threshold));
dat_nrm__(1+tmp_index_,1+nvar) = max(tmp_lo,min(tmp_hi,dat_nrm__(1+tmp_index_,1+nvar)));
end;%for nvar=0:n_var-1;

n_step = 1; dt_all_ = dolphin_dt_all_0(aid_,age_,n_step);
%%%%%%%%;
% global correction for drift. ;
%%%%%%%%;
[a_drift_,b_drift_] = dolphin_estimate_ab_0(aid_,age_,dat_nrm__);
%%%%;
u_aid_ = unique(aid_);
n_aid = numel(u_aid_);
n_aid_ = zeros(n_aid,1);
index_aid__ = cell(n_aid,1);
for naid=0:n_aid-1;
tmp_index_aid_ = efind(aid_==u_aid_(1+naid));
index_aid__{1+naid} = tmp_index_aid_;
n_aid_(1+naid) = numel(index_aid__{1+naid});
tmp_dat_nrm__ = dat_nrm__(1+tmp_index_aid_,:);
tmp_age_ = age_(1+tmp_index_aid_);
tmp_aid_ = aid_(1+tmp_index_aid_);
%%%%%%%%;
% local correction for drift (i.e., for each dolphin). ;
%%%%%%%%;
if (flag_drift0==0); [tmp_a_drift_,tmp_b_drift_] = dolphin_estimate_ab_0(tmp_aid_,tmp_age_,tmp_dat_nrm__); end;
if (flag_drift0==2); tmp_dat_nrm__ = tmp_dat_nrm__ - (ones(numel(tmp_age_),1)*reshape(tmp_b_drift_,[1,n_var]) + tmp_age_*reshape(tmp_a_drift_,[1,n_var])); end;
if (flag_drift0==1); tmp_dat_nrm__ = tmp_dat_nrm__ - (ones(numel(tmp_age_),1)*reshape(b_drift_,[1,n_var]) + tmp_age_*reshape(a_drift_,[1,n_var])); end;
if (flag_drift0==0); tmp_dat_nrm__ = tmp_dat_nrm__; end;
if (flag_drift0==0 & flag_center==1); tmp_dat_nrm__ = normalize(tmp_dat_nrm__,'zscore'); end;
if (flag_drift0==0 & flag_center==0); tmp_dat_nrm__ = tmp_dat_nrm__; end;
dat_nrm__(1+tmp_index_aid_,:) = tmp_dat_nrm__;
end;%for naid=0:n_aid-1;
if (flag_drift0>=1 & flag_center==1); dat_nrm__ = normalize(dat_nrm__,'zscore'); end;
if (flag_drift0>=1 & flag_center==0); dat_nrm__ = dat_nrm__; end;
%%%%;
n_step = 1; relative_variation = dolphin_relative_variation_0(aid_,age_,dat_nrm__,n_step);

%%%%%%%%;
% select dolphin. ;
%%%%%%%%;
if dXX>0; 
naid = efind(u_aid_==dXX);
if (numel(naid)==0); disp(sprintf(' %% dXX %d not found',dXX)); return; end;
disp(sprintf(' %% dXX %d, naid %d',dXX,naid));
tmp_index_aid_ = efind(aid_==u_aid_(1+naid));
aid_ = aid_(1+tmp_index_aid_);
age_ = age_(1+tmp_index_aid_);
dat_nrm__ = dat_nrm__(1+tmp_index_aid_,:);
end;%if dXX>0; 

dat__ = dat_nrm__;


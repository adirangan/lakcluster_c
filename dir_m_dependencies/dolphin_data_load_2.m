clear;
setup_OptiPlex;
dir_trunk = '/home/rangan/dir_bcc/dir_dolphin';
dir_jpg = sprintf('%s/dir_jpg',dir_trunk);

flag_replot=0;

fname_data = sprintf('%s/Dolphin_Data_201918755_s2.xlsx',dir_trunk);
T_ = readtable(fname_data);
aid_ori_ = T_{:,1};
age_ori_ = T_{:,4};
nvar_base = 7;
dat_ori__ = T_{:,(1+nvar_base):end};
n_smp_ori = size(dat_ori__,1);
n_var_ori = size(dat_ori__,2);
string_dat_ori_name_ = cell(n_var_ori,1);
for nvar=0:n_var_ori-1;
string_dat_ori_name_{1+nvar} = T_.Properties.VariableNames{1+nvar_base+nvar};
end;%for nvar=0:n_var_ori-1;

dat_ret__ = dat_ori__;
mss_var_threshold = 500;
index_var_rmv_ = efind(sum(~isfinite(dat_ret__),1)>mss_var_threshold);
index_var_rmv_ = union(index_var_rmv_,efind(strcmp(string_dat_ori_name_,'RBCDist')));
index_var_rmv_ = union(index_var_rmv_,efind(strcmp(string_dat_ori_name_,'Albumin')));
index_var_ret_ = setdiff(0:n_var_ori-1,index_var_rmv_);
dat_ret__ = dat_ret__(:,1+index_var_ret_);
n_var_ret = size(dat_ret__,2);
string_dat_ret_name_ = cell(n_var_ret,1);
for nvar=0:n_var_ret-1;
string_dat_ret_name_{1+nvar} = string_dat_ori_name_{1+index_var_ret_(1+nvar)};
end;%for nvar=0:n_var_ret-1;

mss_smp_threshold = 7;
index_smp_ret_ = setdiff(0:n_smp_ori-1,efind(sum(~isfinite(dat_ret__),2)>mss_smp_threshold));
dat_ret__ = dat_ret__(1+index_smp_ret_,:);
n_smp_ret = size(dat_ret__,1);

fname_fig = sprintf('%s/dolphin_ori_vs_ret',dir_jpg);
if (flag_replot | ~exist(sprintf('%s.jpg',fname_fig),'file'));
disp(sprintf(' %% %s not found, creating',fname_fig));
subplot(2,2,1); stairs(cumsum(sort(sum(~isfinite(dat_ori__),1)))/numel(dat_ori__)); title('cumsum(sum(~isfinite(dat_ori__),1))','Interpreter','none');
subplot(2,2,2); stairs(cumsum(sort(sum(~isfinite(dat_ori__),2)))/numel(dat_ori__)); title('cumsum(sum(~isfinite(dat_ori__),2))','Interpreter','none');
subplot(2,2,3); stairs(cumsum(sort(sum(~isfinite(dat_ret__),1)))/numel(dat_ret__)); title('cumsum(sum(~isfinite(dat_ret__),1))','Interpreter','none');
subplot(2,2,4); stairs(cumsum(sort(sum(~isfinite(dat_ret__),2)))/numel(dat_ret__)); title('cumsum(sum(~isfinite(dat_ret__),2))','Interpreter','none');
figbig;
sgtitle('original vs retained')
disp(sprintf(' %% writing %s',fname_fig));
print('-depsc',sprintf('%s.eps',fname_fig));
print('-djpeg',sprintf('%s.jpg',fname_fig));
close(gcf);
end;%if (~exist(sprintf('%s.jpg',fname_fig),'file'));
if ( exist(sprintf('%s.jpg',fname_fig),'file'));
disp(sprintf(' %% %s found, not creating',fname_fig));
end;%if ( exist(sprintf('%s.jpg',fname_fig),'file'));

aid_ret_ = aid_ori_(1+index_smp_ret_);
age_ret_ = age_ori_(1+index_smp_ret_);

aid_ = aid_ret_;
age_ = age_ret_;
dat_nrm__ = dat_ret__;
[n_smp,n_var] = size(dat_nrm__);
string_dat_name_ = string_dat_ret_name_;
prctile_threshold = 0.01;
for nvar=0:n_var-1;
tmp_index_ = efind(isfinite(dat_nrm__(:,1+nvar)));
tmp_lo = prctile(dat_nrm__(1+tmp_index_,1+nvar),100*prctile_threshold);
tmp_hi = prctile(dat_nrm__(1+tmp_index_,1+nvar),100*(1-prctile_threshold));
dat_nrm__(1+tmp_index_,1+nvar) = max(tmp_lo,min(tmp_hi,dat_nrm__(1+tmp_index_,1+nvar)));
end;%for nvar=0:n_var-1;

u_aid_ = unique(aid_);
n_aid = numel(u_aid_);
n_aid_ = zeros(n_aid,1);
index_aid__ = cell(n_aid,1);
for naid=0:n_aid-1;
tmp_index_aid_ = efind(aid_==u_aid_(1+naid));
index_aid__{1+naid} = tmp_index_aid_;
n_aid_(1+naid) = numel(index_aid__{1+naid});
tmp_dat_nrm__ = normalize(dat_nrm__(1+tmp_index_aid_,:),'zscore');
dat_nrm__(1+tmp_index_aid_,:) = tmp_dat_nrm__;
end;%for naid=0:n_aid-1;

dat__ = dat_nrm__;

dt_all_ = [];
for naid=0:n_aid-1;
tmp_index_aid_ = index_aid__{1+naid};
tmp_age_ = age_(1+tmp_index_aid_);
[tmp_age_,tmp_index_] = sort(tmp_age_,'ascend'); tmp_index_ = tmp_index_-1;
dt_ = diff(tmp_age_);
dt_all_ = [dt_all_;dt_];
end;%for naid=0:n_aid-1;

fname_fig = sprintf('%s/dolphin_dt_scatter_A',dir_jpg);
if (flag_replot | ~exist(sprintf('%s.jpg',fname_fig),'file'));
disp(sprintf(' %% %s not found, creating',fname_fig));
figure(1);
clf;
c_ = colormap_beach(); n_c = size(c_,1);
n_plot_row = 5;
n_plot_col = 10;
nplot=0;
for nvar=0:24;%for nvar=0:n_var-1;
dt_all_ = [];
dv_all_ = [];
for naid=0:n_aid-1;
nc = max(0,min(n_c-1,floor(n_c*naid/n_aid)));
tmp_index_finite_ = efind(isfinite(dat__(1+index_aid__{1+naid},1+nvar)));
tmp_index_aid_ = index_aid__{1+naid}(1+tmp_index_finite_);
tmp_age_ = age_(1+tmp_index_aid_);
[tmp_age_,tmp_index_] = sort(tmp_age_,'ascend'); tmp_index_ = tmp_index_-1;
tmp_var_ = dat__(1+tmp_index_aid_,1+nvar); tmp_var_ = tmp_var_(1+tmp_index_);
dt_ = diff(tmp_age_);
dv_ = diff(tmp_var_);
dt_all_ = [dt_all_;dt_];
dv_all_ = [dv_all_;dv_];
subplot(n_plot_row,n_plot_col,1+nplot+0);
hold on;
plot(sqrt(dt_),dv_,'.','Color',c_(1+nc,:));
hold off;
end;%for naid=0:n_aid-1;
xlim_ = sqrt([0,5]);
ylim_ = prctile(dv_all_,[1,99]);
%subplot(n_plot_row,n_plot_col,1+nplot+1);
%plot(tmp_age_,tmp_var_,'.-','Color',c_(1+nc,:));
subplot(n_plot_row,n_plot_col,1+nplot+0);
xlim(xlim_); ylim(ylim_); title(sprintf('%s',string_dat_name_{1+nvar}));
subplot(n_plot_row,n_plot_col,1+nplot+1);
n_h = 32;
tmp_h__ = hist2d_0(sqrt(dt_all_),dv_all_,n_h,n_h,xlim_,ylim_);
tmp_e_ = linspace(ylim_(1),ylim_(2),n_h);
tmp_b_ = 1:n_h;
tmp_avg_ = zeros(n_h,1);
tmp_std_ = zeros(n_h,1);
for nh=0:n_h-1;
tmp_h__(:,1+nh) = tmp_h__(:,1+nh)/max(1,sum(tmp_h__(:,1+nh)));
tmp_avg_(1+nh) = dot(tmp_b_,tmp_h__(:,1+nh));
tmp_std_(1+nh) = sqrt(dot(tmp_b_.*tmp_b_,tmp_h__(:,1+nh)) - tmp_avg_(1+nh).^2);
end;%for nh=0:31;
hold on;
imagesc(tmp_h__,[0.02,0.20]);
colormap(colormap_beach());
plot(tmp_b_,tmp_avg_,'k.');
plot(tmp_b_,tmp_avg_+1.0*tmp_std_,'k.');
plot(tmp_b_,tmp_avg_-1.0*tmp_std_,'k.');
hold off;
xlim([1,n_h]); ylim([1,n_h]);
axisnotick;
title(sprintf('%s',string_dat_name_{1+nvar}));
nplot=nplot+2;
end;%for nvar=0:n_var-1;
figbig;
sgtitle('sqrt(dt) horizontal, dv vertical')
disp(sprintf(' %% writing %s',fname_fig));
print('-depsc',sprintf('%s.eps',fname_fig));
print('-djpeg',sprintf('%s.jpg',fname_fig));
close(gcf);
end;%if (~exist(sprintf('%s.jpg',fname_fig),'file'));
if ( exist(sprintf('%s.jpg',fname_fig),'file'));
disp(sprintf(' %% %s found, not creating',fname_fig));
end;%if ( exist(sprintf('%s.jpg',fname_fig),'file'));

fname_fig = sprintf('%s/dolphin_dt_scatter_B',dir_jpg);
if (flag_replot | ~exist(sprintf('%s.jpg',fname_fig),'file'));
disp(sprintf(' %% %s not found, creating',fname_fig));
figure(1);
clf;
c_ = colormap_beach(); n_c = size(c_,1);
n_plot_row = 5;
n_plot_col = 10;
nplot=0;
for nvar=25:n_var-1;%for nvar=0:n_var-1;
dt_all_ = [];
dv_all_ = [];
for naid=0:n_aid-1;
nc = max(0,min(n_c-1,floor(n_c*naid/n_aid)));
tmp_index_finite_ = efind(isfinite(dat__(1+index_aid__{1+naid},1+nvar)));
tmp_index_aid_ = index_aid__{1+naid}(1+tmp_index_finite_);
tmp_age_ = age_(1+tmp_index_aid_);
[tmp_age_,tmp_index_] = sort(tmp_age_,'ascend'); tmp_index_ = tmp_index_-1;
tmp_var_ = dat__(1+tmp_index_aid_,1+nvar); tmp_var_ = tmp_var_(1+tmp_index_);
dt_ = diff(tmp_age_);
dv_ = diff(tmp_var_);
dt_all_ = [dt_all_;dt_];
dv_all_ = [dv_all_;dv_];
subplot(n_plot_row,n_plot_col,1+nplot+0);
hold on;
plot(sqrt(dt_),dv_,'.','Color',c_(1+nc,:));
hold off;
end;%for naid=0:n_aid-1;
xlim_ = sqrt([0,5]);
ylim_ = prctile(dv_all_,[1,99]);
%subplot(n_plot_row,n_plot_col,1+nplot+1);
%plot(tmp_age_,tmp_var_,'.-','Color',c_(1+nc,:));
subplot(n_plot_row,n_plot_col,1+nplot+0);
xlim(xlim_); ylim(ylim_); title(sprintf('%s',string_dat_name_{1+nvar}));
subplot(n_plot_row,n_plot_col,1+nplot+1);
n_h = 32;
tmp_h__ = hist2d_0(sqrt(dt_all_),dv_all_,n_h,n_h,xlim_,ylim_);
tmp_e_ = linspace(ylim_(1),ylim_(2),n_h);
tmp_b_ = 1:n_h;
tmp_avg_ = zeros(n_h,1);
tmp_std_ = zeros(n_h,1);
for nh=0:n_h-1;
tmp_h__(:,1+nh) = tmp_h__(:,1+nh)/max(1,sum(tmp_h__(:,1+nh)));
tmp_avg_(1+nh) = dot(tmp_b_,tmp_h__(:,1+nh));
tmp_std_(1+nh) = sqrt(dot(tmp_b_.*tmp_b_,tmp_h__(:,1+nh)) - tmp_avg_(1+nh).^2);
end;%for nh=0:31;
hold on;
imagesc(tmp_h__,[0.02,0.20]);
colormap(colormap_beach());
plot(tmp_b_,tmp_avg_,'k.');
plot(tmp_b_,tmp_avg_+1.0*tmp_std_,'k.');
plot(tmp_b_,tmp_avg_-1.0*tmp_std_,'k.');
hold off;
xlim([1,n_h]); ylim([1,n_h]);
axisnotick;
title(sprintf('%s',string_dat_name_{1+nvar}));
nplot=nplot+2;
end;%for nvar=0:n_var-1;
figbig;
sgtitle('sqrt(dt) horizontal, dv vertical')
disp(sprintf(' %% writing %s',fname_fig));
print('-depsc',sprintf('%s.eps',fname_fig));
print('-djpeg',sprintf('%s.jpg',fname_fig));
close(gcf);
end;%if (~exist(sprintf('%s.jpg',fname_fig),'file'));
if ( exist(sprintf('%s.jpg',fname_fig),'file'));
disp(sprintf(' %% %s found, not creating',fname_fig));
end;%if ( exist(sprintf('%s.jpg',fname_fig),'file'));

a_ = zeros(n_var,1);
A__ = zeros(n_var,n_var); 
n_step = 1;

index_mss_ = efind(~isfinite(dat__));
BB__ = []; CC__ = [];
%%%%%%%%;
% Now impute data using A. ;
%%%%%%%%;
dat_imp__ = dolphin_impute_aA_0(aid_,age_,dat__,a_,A__,index_mss_);
%%%%%%%%;
% Now estimate initial B,C. ;
%%%%%%%%;
[BB__,CC__,l2_R__,sum_1,sum_dt,sum_dtdt,sum_DDj__,sum_DDjdt__] = dolphin_estimate_BC_from_aA_0(aid_,age_,dat_imp__,a_,A__,n_step);
[BB_crude__,CC_crude__] = dolphin_estimate_BC_from_aA_crude_0(aid_,age_,dat_imp__,a_,A__,n_step);
disp(sprintf(' %% BB__ vs BB_crude__: %0.16f',fnorm(BB__ - BB_crude__)/fnorm(BB__)));
disp(sprintf(' %% CC__ vs CC_crude__: %0.16f',fnorm(CC__ - CC_crude__)/fnorm(CC__)));
BB__ = BB_crude__; CC__ = CC_crude__; %<-- use crude method. ;
fname_fig = sprintf('%s/dolphin_BCD_0',dir_jpg);
if (flag_replot | ~exist(sprintf('%s.jpg',fname_fig),'file'));
disp(sprintf(' %% %s not found, creating',fname_fig));
figure(1);
clf;
colormap(colormap_beach());
subplot(2,3,1+0);
imagesc(BB__); axis image; title('BB__','Interpreter','none');
set(gca,'XTick',1:n_var,'XTickLabel',string_dat_name_);xtickangle(90);
set(gca,'YTick',1:n_var,'YTickLabel',string_dat_name_);
subplot(2,3,2+0);
imagesc(CC__); axis image; title('CC__','Interpreter','none');
set(gca,'XTick',1:n_var,'XTickLabel',string_dat_name_);xtickangle(90);
set(gca,'YTick',1:n_var,'YTickLabel',string_dat_name_);
subplot(2,3,3+0);
imagesc(log10(l2_R__)); axis image; title('log10(l2_R__)','Interpreter','none');
set(gca,'XTick',1:n_var,'XTickLabel',string_dat_name_);xtickangle(90);
set(gca,'YTick',1:n_var,'YTickLabel',string_dat_name_);
subplot(2,3,1+3);
plot(diag(BB__),'ko'); title('BB__','Interpreter','none');
set(gca,'XTick',1:n_var,'XTickLabel',string_dat_name_);xtickangle(90);
subplot(2,3,2+3);
plot(diag(CC__),'ko'); title('CC__','Interpreter','none');
set(gca,'XTick',1:n_var,'XTickLabel',string_dat_name_);xtickangle(90);
subplot(2,3,3+3);
plot(diag(log10(l2_R__)),'ko'); title('log10(l2_R__)','Interpreter','none');
set(gca,'XTick',1:n_var,'XTickLabel',string_dat_name_);xtickangle(90);
figbig;
sgtitle('initial BB__, CC__ and log10(l2_R__)','Interpreter','none')
disp(sprintf(' %% writing %s',fname_fig));
print('-depsc',sprintf('%s.eps',fname_fig));
print('-djpeg',sprintf('%s.jpg',fname_fig));
close(gcf);
end;%if (~exist(sprintf('%s.jpg',fname_fig),'file'));
if ( exist(sprintf('%s.jpg',fname_fig),'file'));
disp(sprintf(' %% %s found, not creating',fname_fig));
end;%if ( exist(sprintf('%s.jpg',fname_fig),'file'));

%%%%%%%%;
% Now estimate a_ and A__ from BB__ and CC__. ;
%%%%%%%%;
dt_lim_ = [0;max(dt_all_)];
[a_,A__,L] = dolphin_estimate_aA_from_BC_0(aid_,age_,dat_imp__,BB__,CC__,dt_lim_,n_step);
disp(sprintf(' %% initial: negative-log-likelihood %0.16f',L));
%%%%%%%%;
% Now iterate a few times. ;
%%%%%%%%;
n_iteration = 4;
L_ = zeros(n_iteration+1,1);
a__ = cell(1+n_iteration,1);
A___ = cell(1+n_iteration,1);
BB___ = cell(1+n_iteration,1);
CC___ = cell(1+n_iteration,1);
niteration=0;
L_old = L;
L_(1+niteration) = L_old;
a__{1+niteration} = a_;
A___{1+niteration} = A__;
BB___{1+niteration} = BB__;
CC___{1+niteration} = CC__;
flag_continue=1;
while (flag_continue);
% Re-impute data using A. ;
dat_imp__ = dolphin_impute_aA_0(aid_,age_,dat__,a_,A__,index_mss_);
% Re-estimate B,C. ;
[BB__,CC__,l2_R__,sum_1,sum_dt,sum_dtdt,sum_DDj__,sum_DDjdt__] = dolphin_estimate_BC_from_aA_0(aid_,age_,dat_imp__,a_,A__,n_step);
[BB_crude__,CC_crude__] = dolphin_estimate_BC_from_aA_crude_0(aid_,age_,dat_imp__,a_,A__,n_step);
disp(sprintf(' %% BB__ vs BB_crude__: %0.16f',fnorm(BB__ - BB_crude__)/fnorm(BB__)));
disp(sprintf(' %% CC__ vs CC_crude__: %0.16f',fnorm(CC__ - CC_crude__)/fnorm(CC__)));
BB__ = BB_crude__; CC__ = CC_crude__; %<-- use crude method. ;
% Re-estimate a_ and A__ from BB__ and CC__. ;
[a_,A__,L] = dolphin_estimate_aA_from_BC_0(aid_,age_,dat_imp__,BB__,CC__,dt_lim_,n_step);
L_new = L; L_(1+niteration+1)=L;
a__{1+niteration+1} = a_;
A___{1+niteration+1} = A__;
BB___{1+niteration+1} = BB__;
CC___{1+niteration+1} = CC__;
disp(sprintf(' %% iteration %d: negative-log-likelihood %0.16f',niteration,L));
flag_continue=0;
niteration=niteration+1;
if (niteration<n_iteration & fnorm(L_old-L_new)/fnorm(L_old)>1e-3); flag_continue=1; end;
L_old = L_new;
end;%while (flag_continue);

fname_fig = sprintf('%s/dolphin_ABC_0',dir_jpg);
if (flag_replot | ~exist(sprintf('%s.jpg',fname_fig),'file'));
disp(sprintf(' %% %s not found, creating',fname_fig));
figure(1);
clf;
subplot(2,2,1);
bar(a_);
set(gca,'XTick',1:n_var,'XTickLabel',string_dat_name_); xtickangle(90);
title('drift a_','Interpreter','none');
subplot(2,2,2);
colormap(colormap_beach());
imagesc(A__); axis image;
set(gca,'YTick',1:n_var,'YTickLabel',string_dat_name_);
set(gca,'XTick',1:n_var,'XTickLabel',string_dat_name_); xtickangle(90);
set(gca,'TickLength',[0,0]);
set(gca,'fontsize',6);
colorbar;
title('interaction A__','Interpreter','none');
subplot(2,2,3);
colormap(colormap_beach());
imagesc(BB__); axis image;
set(gca,'YTick',1:n_var,'YTickLabel',string_dat_name_);
set(gca,'XTick',1:n_var,'XTickLabel',string_dat_name_); xtickangle(90);
set(gca,'TickLength',[0,0]);
set(gca,'fontsize',6);
colorbar;
title('SDE noise BB__','Interpreter','none');
subplot(2,2,4);
colormap(colormap_beach());
imagesc(CC__); axis image;
set(gca,'YTick',1:n_var,'YTickLabel',string_dat_name_);
set(gca,'XTick',1:n_var,'XTickLabel',string_dat_name_); xtickangle(90);
set(gca,'TickLength',[0,0]);
set(gca,'fontsize',6);
colorbar;
title('observation noise CC__','Interpreter','none');
figbig;
sgtitle('coefficient matrices','Interpreter','none');
disp(sprintf(' %% writing %s',fname_fig));
print('-depsc',sprintf('%s.eps',fname_fig));
print('-djpeg',sprintf('%s.jpg',fname_fig));
close(gcf);
end;%if (~exist(sprintf('%s.jpg',fname_fig),'file'));
if ( exist(sprintf('%s.jpg',fname_fig),'file'));
disp(sprintf(' %% %s found, not creating',fname_fig));
end;%if ( exist(sprintf('%s.jpg',fname_fig),'file'));

%{
  %%%%%%%%;
  % step through each variable and examine the entries. ;
  %%%%%%%%;
  for nvar=0:n_var-1;
  c_ = {'r','k'};
  subplot(2,1,1); cla;
  hold on;
  age_base=0;
  for naid=0:n_aid-1;
  tmp_index_aid_ = index_aid__{1+naid};
  tmp_age_ = age_(1+tmp_index_aid_);
  [tmp_age_,tmp_index_] = sort(tmp_age_,'ascend'); tmp_index_ = tmp_index_-1;
  tmp_var_ = dat_imp__(1+tmp_index_aid_,1+nvar); tmp_var_ = tmp_var_(1+tmp_index_);
  plot(age_base+tmp_age_,tmp_var_,'.','Color',c_{1+mod(naid,2)});
  age_base = age_base + max(tmp_age_) + 1;
  end;%for naid=0:n_aid-1;
  hold off;
  subplot(2,1,2); cla;
  hold on;
  dt_all_ = [];
  dv_all_ = [];
  for naid=0:n_aid-1;
  tmp_index_aid_ = index_aid__{1+naid};
  tmp_age_ = age_(1+tmp_index_aid_);
  [tmp_age_,tmp_index_] = sort(tmp_age_,'ascend'); tmp_index_ = tmp_index_-1;
  tmp_var_ = dat_imp__(1+tmp_index_aid_,1+nvar); tmp_var_ = tmp_var_(1+tmp_index_);
  dt_ = diff(tmp_age_);
  dv_ = diff(tmp_var_);
  dt_all_ = [dt_all_;dt_];
  dv_all_ = [dv_all_;dv_];
  end;%for naid=0:n_aid-1;
  plot(dt_all_,dv_all_.^2,'k.');
  hold off;
  sgtitle(sprintf('%d %s',nvar,string_dat_name_{1+nvar}));
  drawnow();
  pause();
  end;%for nvar=0:n_var-1;
  %}
